const owner="erw-1",repo="erw.one",basePath="files/img/photo/",branch="main",galleryContainer=document.getElementById("gallery"),breadcrumbContainer=document.getElementById("breadcrumb"),errorMessage=document.getElementById("error-message");let currentFolder="",currentIndex=0,currentImages=[],lightbox,lightboxImg,cachedTree=null;async function fetchGitHubTree(){if(cachedTree)return cachedTree;let e=`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;try{let t=await fetch(e,{headers:{Accept:"application/vnd.github.v3+json"}});if(!t.ok)throw Error("Failed to fetch recursive tree");let r=await t.json();return cachedTree=r.tree}catch(n){return showError("Rate limit exceeded or API error"),null}}function showError(e){errorMessage.textContent=e,errorMessage.style.display="block"}function clearGallery(){galleryContainer.innerHTML="",errorMessage.style.display="none"}function createBreadcrumbs(e){breadcrumbContainer.innerHTML="";let t=createLink("Home","#",e=>{e.preventDefault(),showTopLevelFolders()});breadcrumbContainer.appendChild(t);let r=e.replace(basePath,"").split("/").filter(Boolean),n=[];r.forEach(e=>{n.push(e);let t=`${basePath}${n.join("/")}`;breadcrumbContainer.appendChild(createSeparator());let r=createLink(e,"#",e=>{e.preventDefault(),showFolderContents(t)});breadcrumbContainer.appendChild(r)})}function createSeparator(){let e=document.createElement("span");return e.textContent="/",e.className="separator",e}function createLink(e,t,r){let n=document.createElement("a");return n.href=t,n.textContent=e,n.onclick=r,n}function createDivElement({className:e,imageUrl:t,onClick:r,titleText:n=null}){let a=document.createElement("div");if(a.className=e,a.style.backgroundImage=`url('${t}')`,a.onclick=r,n){let l=document.createElement("div");l.className="title",l.textContent=n,a.appendChild(l)}return observeBackgroundImageChange(a),a}function observeBackgroundImageChange(e){let t=new MutationObserver(()=>{let t=e.style.backgroundImage;if(t&&t.startsWith('url("')){let r=t.slice(5,-2),n=new Image;n.src=r,n.onload=()=>{let t=n.naturalWidth/n.naturalHeight;e.style.width=`${200*t}px`,e.style.height="auto"}}});t.observe(e,{attributes:!0})}async function showTopLevelFolders(){clearGallery();let e=await fetchGitHubTree();if(!e)return;let t=getFilteredItems(e,basePath,"tree");t.forEach(e=>{let t=e.path.replace(basePath,""),r=getRandomImageUrl(e.path),n=createDivElement({className:"folder",imageUrl:r,onClick:()=>showFolderContents(e.path),titleText:t});galleryContainer.appendChild(n)}),createBreadcrumbs(basePath)}async function showFolderContents(e){clearGallery(),currentFolder=e,currentImages=[];let t=await fetchGitHubTree();if(!t)return;createBreadcrumbs(e);let r=getFolderContents(t,e);r.forEach(t=>{let r=t.path.replace(`${e}/`,"");if("tree"===t.type)renderGalleryItem({type:"folder",path:t.path,name:r,onClick:()=>showFolderContents(t.path)});else if("blob"===t.type&&t.path.endsWith(".jxl")){currentImages.push(t.path);let n=currentImages.length-1;renderGalleryItem({type:"photo",path:t.path,onClick:()=>openLightbox(n)})}})}function getFilteredItems(e,t,r){return e.filter(e=>{let n=e.path.replace(`${t}`,""),a=-1===n.indexOf("/");return e.type===r&&e.path.startsWith(t)&&a})}function getFolderContents(e,t){return e.filter(e=>{let r=e.path.replace(`${t}/`,"");return e.path.startsWith(t)&&-1===r.indexOf("/")})}function getGitHubRawUrl(e){return`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${e}`}function getRandomImageUrl(e){let t=cachedTree.filter(t=>{let r=t.path.replace(`${e}/`,"");return t.path.startsWith(e)&&t.path.endsWith(".jxl")&&!r.includes("/")});if(t.length>0){let r=Math.floor(Math.random()*t.length);return getGitHubRawUrl(t[r].path)}}function renderGalleryItem({type:e,path:t,name:r,onClick:n}){let a="folder"===e?getRandomImageUrl(t):getGitHubRawUrl(t),l=createDivElement({className:"folder"===e?"folder":"photo",imageUrl:a,onClick:n,titleText:"folder"===e?r:null});galleryContainer.appendChild(l)}function openLightbox(e){currentIndex=e,createLightbox(),loadImage(currentIndex),lightbox.style.display="flex",document.addEventListener("keydown",handleKeyDown),lightbox.addEventListener("touchstart",handleTouchStart),lightbox.addEventListener("touchend",handleTouchEnd)}function closeLightbox(){lightbox.style.display="none",document.removeEventListener("keydown",handleKeyDown),lightbox.removeEventListener("touchstart",handleTouchStart),lightbox.removeEventListener("touchend",handleTouchEnd)}function handleKeyDown(e){"ArrowLeft"===e.key?navigate(-1):"ArrowRight"===e.key?navigate(1):"Escape"===e.key&&closeLightbox()}function handleTouchStart(e){let t=e.changedTouches[0].screenX;lightbox.dataset.touchStartX=t}function handleTouchEnd(e){let t=e.changedTouches[0].screenX,r=parseFloat(lightbox.dataset.touchStartX);handleSwipeGesture(r,t)}function handleSwipeGesture(e,t){t<e-50?navigate(1):t>e+50&&navigate(-1)}function createLightbox(){lightbox||((lightbox=document.createElement("div")).id="lightbox",lightbox.className="lightbox",document.body.appendChild(lightbox),(lightboxImg=document.createElement("img")).id="lightbox-img",lightboxImg.className="lightbox-img",lightbox.appendChild(lightboxImg),createNavButton("prev","&#10094;"),createNavButton("next","&#10095;"),lightbox.onclick=e=>{e.target===lightbox&&closeLightbox()})}function loadImage(e){let t=currentImages[e],r=getGitHubRawUrl(t);lightboxImg.src=r}function createNavButton(e,t){let r=document.createElement("span");r.id=e,r.className="nav",r.innerHTML=t,r.onclick=navigateLightbox,lightbox.appendChild(r)}function navigateLightbox(e){e.stopPropagation();let t="next"===e.target.id?1:-1;navigate(t)}function navigate(e){loadImage(currentIndex=(currentIndex+e+currentImages.length)%currentImages.length)}showTopLevelFolders();