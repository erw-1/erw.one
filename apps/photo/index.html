<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery with JXL.js</title>
    <script src="serviceworker.min.js"></script>
    <script src="jxl.min.js"></script>
    <style>
        /* Basic styles for your gallery */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
        }

        .folder, .photo {
            width: 200px;
            height: 200px;
            margin: 10px;
            background-color: #fff;
            position: relative;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .folder img, .photo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .folder:hover img, .photo:hover img {
            transform: scale(1.1);
        }

        .title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            text-align: center;
            padding: 10px;
            font-size: 18px;
            box-sizing: border-box;
        }

        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #lightbox img {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        #prev, #next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 50px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            padding: 20px;
            z-index: 1001;
        }

        #prev {
            left: 0;
        }

        #next {
            right: 0;
        }
    </style>
</head>
<body>

<div id="gallery" class="container"></div>

<div id="lightbox">
    <span id="prev">&#10094;</span>
    <img id="lightbox-img" src="">
    <span id="next">&#10095;</span>
</div>

<script>
    // Define your GitHub token and repo information
    const token = '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';  // public repo browser
    const owner = 'erw-1';
    const repo = 'erw.one';
    const basePath = 'img/photo/';
    const branch = 'main'; // Replace with the correct branch if not main

    const galleryContainer = document.getElementById('gallery');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');

    let currentFolder = '';
    let currentIndex = 0;
    let currentImages = [];

    // Function to fetch contents from GitHub with authentication
    async function fetchGitHubContents(path) {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: {
                'Authorization': `token ${token}`
            }
        });
        return response.json();
    }

    // Function to display folders
    async function showFolders() {
        galleryContainer.innerHTML = '';
        const folders = await fetchGitHubContents(basePath);

        folders.forEach(folder => {
            if (folder.type === 'dir') {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'folder';
                folderDiv.innerHTML = `
                    <img src="https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${folder.path}/preview.jxl" alt="${folder.name}" data-jxl-src="https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${folder.path}/preview.jxl">
                    <div class="title">${folder.name}</div>
                `;
                folderDiv.onclick = () => showPhotos(folder.path);
                galleryContainer.appendChild(folderDiv);
            }
        });
    }

    // Function to display photos in a folder
    async function showPhotos(folderPath) {
        currentFolder = folderPath;
        galleryContainer.innerHTML = '';
        const files = await fetchGitHubContents(folderPath);

        currentImages = files.filter(file => file.name.endsWith('.jxl'));

        currentImages.forEach((image, index) => {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo';
            photoDiv.innerHTML = `
                <img src="https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${image.path}" alt="${image.name}" data-jxl-src="https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${image.path}">
            `;
            photoDiv.onclick = () => openLightbox(index);
            galleryContainer.appendChild(photoDiv);
        });
    }

    // Function to open the lightbox
    function openLightbox(index) {
        currentIndex = index;
        updateLightbox();
        lightbox.style.display = 'flex';
    }

    // Function to update the lightbox image
    function updateLightbox() {
        const imagePath = currentImages[currentIndex].path;
        lightboxImg.dataset.jxlSrc = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${imagePath}`;
        lightboxImg.src = ''; // This clears the src to trigger the error handling for .jxl
    }

    // Functions to navigate through images in the lightbox
    function navigate(direction) {
        currentIndex = (currentIndex + direction + currentImages.length) % currentImages.length;
        updateLightbox();
    }

    // Function to close the lightbox
    function closeLightbox() {
        lightbox.style.display = 'none';
    }

    prevBtn.onclick = () => navigate(-1);
    nextBtn.onclick = () => navigate(1);
    lightbox.onclick = closeLightbox;

    showFolders();
</script>

</body>
</html>
