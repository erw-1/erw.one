<!DOCTYPE html>
<html>
<head>
  <title>Render GeoParquet on Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="./wellknown.min.js"></script> <!-- Include WKT parser -->
</head>
<body>
  <div id="map" style="height: 600px;"></div>
  <script type="module">
    import initParquetWasm, { readParquet } from "./parquet_wasm.js";
    import * as arrow from "https://cdn.jsdelivr.net/npm/apache-arrow@10.0.1/+esm";

    (async function () {
      try {
        console.log("Initializing WebAssembly...");
        await initParquetWasm();

        console.log("Fetching GeoParquet file...");
        const response = await fetch("./data.parquet"); // Replace with your file path
        if (!response.ok) throw new Error("Failed to fetch GeoParquet file.");
        const parquetBytes = new Uint8Array(await response.arrayBuffer());

        console.log("Reading Parquet file...");
        const wasmTable = readParquet(parquetBytes, { batchSize: Math.pow(2, 31) });
        const arrowTable = arrow.tableFromIPC(wasmTable.intoIPCStream());
        console.log("Arrow Table:", arrowTable);

        // Extract geometry column
        console.log("Extracting Geometry...");
        const geometryColumn = arrowTable.getChild("geometry"); // Replace "geometry" with your actual column name
        if (!geometryColumn) throw new Error("Geometry column not found.");

        const wktValues = geometryColumn.toArray(); // Assuming WKT geometries are stored

        // Initialize Leaflet Map
        const map = L.map("map").setView([0, 0], 2); // Center at [0, 0], zoom level 2
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        // Render geometries directly
        console.log("Rendering Geometries...");
        wktValues.forEach((wkt, index) => {
          const geometry = wellknown.parse(wkt); // Parse WKT to Leaflet-compatible geometry
          if (!geometry) {
            console.warn(`Invalid WKT geometry at index ${index}:`, wkt);
            return;
          }

          if (geometry.type === "Point") {
            L.marker([geometry.coordinates[1], geometry.coordinates[0]]).addTo(map);
          } else if (geometry.type === "Polygon") {
            L.polygon(
              geometry.coordinates.map((ring) => ring.map(([lng, lat]) => [lat, lng]))
            ).addTo(map);
          } else if (geometry.type === "LineString") {
            L.polyline(
              geometry.coordinates.map(([lng, lat]) => [lat, lng])
            ).addTo(map);
          } else {
            console.warn(`Unsupported geometry type at index ${index}:`, geometry.type);
          }
        });

        console.log("Rendering complete!");
      } catch (error) {
        console.error("An error occurred:", error);
      }
    })();
  </script>
</body>
</html>
