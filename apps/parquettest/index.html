<!DOCTYPE html>
<html>
<head>
  <title>GeoParquet with Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
  <div id="map" style="height: 600px;"></div>
  <script type="module">
    import initWasm, { readParquet } from "https://unpkg.com/parquet-wasm@0.6.0/esm/parquet_wasm.js";
    import * as arrow from "https://cdn.jsdelivr.net/npm/apache-arrow@10.0.1/+esm";

    (async function () {
      // Initialize WebAssembly
      await initWasm();

      // Fetch the Parquet file
      const response = await fetch("./data.parquet"); // Replace with your Parquet file path
      const parquetBytes = new Uint8Array(await response.arrayBuffer());

      // Read the Parquet file
      const wasmTable = readParquet(parquetBytes, { batchSize: Math.pow(2, 31) });
      const arrowTable = arrow.tableFromIPC(wasmTable.intoIPCStream());

      // Inspect the table structure
      console.log("Arrow Table:", arrowTable);

      // Extract geometry column
      const geometryColumn = arrowTable.getChild("geometry");
      const flatCoordinates = geometryColumn.getChildAt(0).data[0].values;

      // Extract other columns for properties
      const properties = {};
      arrowTable.schema.fields.forEach((field) => {
        const column = arrowTable.getChild(field.name);
        properties[field.name] = column.data[0].values;
      });

      // Create GeoJSON
      const geojson = {
        type: "FeatureCollection",
        features: [],
      };

      for (let i = 0; i < arrowTable.numRows; i++) {
        const coords = [
          flatCoordinates[i * 2], // Longitude
          flatCoordinates[i * 2 + 1], // Latitude
        ];
        const props = {};
        for (const key in properties) {
          props[key] = properties[key][i];
        }
        geojson.features.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: coords },
          properties: props,
        });
      }

      console.log("GeoJSON Data:", geojson);

      // Initialize Leaflet map
      const map = L.map("map").setView([0, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // Add GeoJSON to the map
      L.geoJSON(geojson).addTo(map);
    })();
  </script>
</body>
</html>
