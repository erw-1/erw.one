<!DOCTYPE html>
<html>
<head>
  <title>HyParquet GeoParquet Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wellknown"></script> <!-- For WKT parsing -->
</head>
<body>
  <h1>HyParquet GeoParquet Viewer</h1>
  <input type="text" id="urlInput" placeholder="Enter GeoParquet URL" value="https://hyperparam-public.s3.amazonaws.com/bunnies.parquet" />
  <button id="loadButton">Load</button>
  <div id="map" style="height: 600px; margin-top: 20px;"></div>

  <script type="module">
    import { asyncBufferFromUrl, parquetRead } from 'https://cdn.jsdelivr.net/npm/hyparquet/src/hyparquet.min.js';

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    const renderGeoParquet = async (url) => {
      try {
        // Load GeoParquet data
        console.log('Fetching GeoParquet file from URL:', url);
        const asyncBuffer = await asyncBufferFromUrl(url);

        console.log('Reading Parquet data...');
        await parquetRead({
          file: asyncBuffer,
          onComplete: (data) => {
            console.log('Parquet Data:', data);

            // Dynamically identify geometry column
            const geoColumn = Object.keys(data).find((key) => key.toLowerCase().includes('geometry'));
            if (!geoColumn) {
              console.error('No geometry column found in the dataset.');
              return;
            }

            // Decode geometries and render on the map
            console.log('Rendering geometries...');
            const geometries = data[geoColumn];
            geometries.forEach((binary, index) => {
              const wkt = new TextDecoder('utf-8').decode(binary);
              const geometry = wellknown.parse(wkt);

              if (!geometry) {
                console.warn(`Invalid geometry at index ${index}:`, wkt);
                return;
              }

              // Render based on geometry type
              if (geometry.type === 'Point') {
                L.marker([geometry.coordinates[1], geometry.coordinates[0]]).addTo(map);
              } else if (geometry.type === 'Polygon') {
                L.polygon(
                  geometry.coordinates.map((ring) => ring.map(([lng, lat]) => [lat, lng]))
                ).addTo(map);
              } else if (geometry.type === 'LineString') {
                L.polyline(
                  geometry.coordinates.map(([lng, lat]) => [lat, lng])
                ).addTo(map);
              } else {
                console.warn(`Unsupported geometry type at index ${index}:`, geometry.type);
              }
            });

            console.log('Rendering complete!');
          },
        });
      } catch (error) {
        console.error('An error occurred while rendering GeoParquet:', error);
      }
    };

    document.getElementById('loadButton').addEventListener('click', () => {
      const url = document.getElementById('urlInput').value;
      if (!url) {
        alert('Please enter a valid URL.');
        return;
      }
      renderGeoParquet(url);
    });
  </script>
</body>
</html>
