<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>km ‚Äì Static Wiki</title>

<!-- ‚îÄ‚îÄ libs (CDN, l√©gers) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css"/>

<!-- ‚îÄ‚îÄ styles minimalistes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<style>
:root{--bg:#1e1e1e;--bg-alt:#2a2a2a;--fg:#d4d4d4;--accent:#569cd6;}
*{box-sizing:border-box;margin:0}
body{height:100vh;display:flex;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,sans-serif;overflow:hidden}

/* sidebar */
#sidebar{width:260px;background:var(--bg-alt);padding:.6rem .4rem;border-right:1px solid #444;overflow-y:auto}
#search{width:100%;padding:.35rem .6rem;margin-bottom:.4rem;border:none;border-radius:6px;background:#3a3a3a;color:var(--fg)}
ul{list-style:none}
#sidebar li{margin:.15rem 0;cursor:pointer}
#sidebar li:hover{color:var(--accent)}
.folder>span::before{content:"‚ñ∏";display:inline-block;margin-right:4px;transition:.2s}
.folder>ul{display:none}.folder.open>ul{display:block}.folder.open>span::before{transform:rotate(90deg)}
#sidebar ul ul{padding-left:1.2em}

/* layout */
main{flex:1;display:flex;flex-direction:column}
header{height:48px;background:var(--bg-alt);display:flex;align-items:center;padding:0 1rem;gap:.5rem}
header a{color:var(--fg);text-decoration:none;padding:4px 8px;border-radius:6px}
header a:hover{background:#3a3a3a}.crumb-current{background:#3a3a3a}
.separator{margin:0 .25rem}
.dropdown{position:relative}.dropdown ul{display:none;position:absolute;top:100%;left:0;background:#3a3a3a;border-radius:4px;padding:.25rem 0}
.dropdown:hover ul{display:block}.dropdown li{white-space:nowrap;padding:6px 12px}
.dropdown li:hover{background:var(--accent)}

#content-area{flex:1;display:flex;overflow:hidden}
#content{flex:1;overflow-y:auto;padding:1rem 2rem;max-width:960px;margin:0 auto}
#content h1,#content h2,#content h3{scroll-margin-top:70px}
#prev-next{display:flex;justify-content:space-between;margin:2rem 0}
#prev-next a{background:#3a3a3a;color:var(--fg);padding:.6rem 1rem;border-radius:6px;text-decoration:none}
#prev-next a:hover{background:var(--accent)}

#util{width:300px;background:var(--bg);padding:.75rem .5rem;border-left:1px solid #444;display:flex;flex-direction:column;gap:1rem}
#graph-box{height:240px;border:1px solid #333;border-radius:8px;position:relative}
#graph-box svg{width:100%;height:100%}
#toc{flex:1;border:1px solid #333;border-radius:8px;padding:.5rem;overflow:auto}
#toc li[data-level="2"]{padding-left:12px}#toc li[data-level="3"]{padding-left:24px}
#toc a{color:var(--accent);text-decoration:none}

#modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:.2s}
#modal.open{opacity:1;visibility:visible}
#modal .close{position:absolute;top:1rem;right:1rem;font-size:2rem;color:#fff;cursor:pointer}
#modal svg{width:80vw;height:80vh}
</style>
</head>

<body>
<aside id="sidebar">
  <input id="search" placeholder="Recherche‚Ä¶" autocomplete="off"/>
  <ul id="tree"></ul>
</aside>

<main>
  <header id="crumb"></header>
  <div id="content-area">
    <article id="content"></article>
    <section id="util">
      <div id="graph-box"><svg id="mini"></svg>
        <button id="expand" style="position:absolute;top:8px;right:8px">üîç</button>
      </div>
      <nav id="toc"></nav>
    </section>
  </div>
</main>

<div id="modal"><span class="close">‚úï</span><svg id="full"></svg></div>

<script>
/* =========================================================================
   1.  Loader & store  (aucune d√©pendance DOM)
   ========================================================================= */
const MD_PATH = 'content.md';          // markdown local, GitHub Pages

const pages=[], byId=new Map();
let root=null;

/* parse front‚Äëmatter blocs -->
   id:"x" title:"y" parent:"z" tags:"a,b"
------------------------------------------------------------------------- */
fetch(MD_PATH).then(r=>r.text()).then(txt=>{
  for(const [,head,body] of txt.matchAll(/<!--([\s\S]*?)-->\s*([\s\S]*?)(?=<!--|$)/g)){
    const meta={}; head.replace(/(\w+):"([^"]+)"/g,(_,k,v)=>meta[k]=v.trim());
    pages.push({...meta,content:body.trim(),children:[]});
  }
  pages.forEach(p=>byId.set(p.id,p));
  root=byId.get('home')||pages[0];
  pages.forEach(p=>{
    if(p===root) return;
    const par=byId.get(p.parent)||root;
    p.parent=par; par.children.push(p);
  });
  pages.forEach(p=>p.tags=new Set((p.tags||"").split(",").filter(Boolean)));
  initUI();
});

/* helpers hi√©rarchie */
const hashOf=p=>{const a=[];for(let n=p;n&&n.parent;n=n.parent)a.unshift(n.id);return a.join("#");};
function findByPath(arr){let n=root;for(const id of arr){const c=n.children.find(x=>x.id===id);if(!c)break;n=c;}return n;}

/* =========================================================================
   2.  UI monolithe mais rang√©
   ========================================================================= */
function $(sel,sc=document){return sc.querySelector(sel);}
function initUI(){
  buildTree();
  renderGraph();
  route();  window.addEventListener('hashchange',route);

  /* modal */
  $('#expand').onclick=()=>$('#modal').classList.add('open');
  $('#modal .close').onclick=()=>$('#modal').classList.remove('open');

  /* recherche (debounce 150‚ÄØms) */
  let t=0; $('#search').oninput=e=>{
    clearTimeout(t); t=setTimeout(()=>filterTree(e.target.value.toLowerCase()),150);
  };
}

/* --- sidebar ----------------------------------------------------- */
function buildTree(){
  $('#tree').innerHTML='';
  const rec=(list,ul)=>{
    list.sort((a,b)=>a.title.localeCompare(b.title));
    for(const p of list){
      const li=document.createElement('li'); li.dataset.title=p.title.toLowerCase();
      if(p.children.length){
        li.className='folder'; li.innerHTML=`<span>${p.title}</span><ul></ul>`;
        li.firstChild.onclick=()=>li.classList.toggle('open');
        rec(p.children, li.lastChild);
      }else{ li.textContent=p.title; li.onclick=()=>navigate(p); }
      ul.appendChild(li);
    }
  }; rec(root.children,$('#tree'));
}
function filterTree(q){
  $('#tree').querySelectorAll('li').forEach(li=>{
    li.style.display = li.dataset.title.includes(q) ? '' : 'none';
  });
}
const navigate=p=>location.hash='#'+hashOf(p);

/* --- breadcrumb -------------------------------------------------- */
function breadcrumb(p){
  const h=$('#crumb'); h.innerHTML='<a href="#">üè†</a>';
  const chain=[]; for(let n=p;n;n=n.parent) chain.unshift(n); chain.shift();
  chain.forEach((n,i)=>{
    h.insertAdjacentHTML('beforeend','<span class="separator">></span>');
    const sib=n.parent.children;
    if(sib.length>1){
      const wrap=document.createElement('div'); wrap.className='dropdown';
      const a=document.createElement('a'); a.textContent=n.title; a.href='#'+hashOf(n);
      if(i===chain.length-1) a.className='crumb-current';
      const ul=document.createElement('ul');
      sib.forEach(s=>{const li=document.createElement('li'); li.textContent=s.title; li.onclick=()=>navigate(s); ul.appendChild(li);});
      wrap.appendChild(a); wrap.appendChild(ul); h.appendChild(wrap);
    }else{
      const a=document.createElement('a'); a.textContent=n.title; a.href='#'+hashOf(n);
      if(i===chain.length-1)a.className='crumb-current'; h.appendChild(a);
    }
  });
}

/* --- markdown + toc ---------------------------------------------- */
function numberHeaders(el){
  const c=[0,0,0,0,0,0];
  el.querySelectorAll('h1,h2,h3,h4,h5').forEach(h=>{
    const L=+h.tagName[1]-1; c[L]++; for(let i=L+1;i<6;i++)c[i]=0;
    h.id=c.slice(0,L+1).filter(Boolean).join('_');
  });
}
function buildTOC(page){
  const nav=$('#toc'); nav.innerHTML='';
  const heads=$$('#content h1,#content h2,#content h3');
  if(!heads.length) return;
  const ul=document.createElement('ul');
  heads.forEach(h=>{
    const li=document.createElement('li'); li.dataset.level=h.tagName[1];
    const a=document.createElement('a'); a.textContent=h.id+'¬†¬†'+h.textContent;
    a.href='#'+hashOf(page)+'#'+h.id; li.appendChild(a); ul.appendChild(li);
  }); nav.appendChild(ul);
}
function prevNext(page){
  $('#prev-next')?.remove();
  if(!page.parent) return;
  const sib=page.parent.children;if(sib.length<2) return;
  const idx=sib.indexOf(page); const nav=document.createElement('div'); nav.id='prev-next';
  if(idx>0)nav.appendChild(Object.assign(document.createElement('a'),{href:'#'+hashOf(sib[idx-1]),textContent:'‚Üê '+sib[idx-1].title}));
  if(idx<sib.length-1)nav.appendChild(Object.assign(document.createElement('a'),{href:'#'+hashOf(sib[idx+1]),textContent:sib[idx+1].title+' ‚Üí'}));
  $('#content').appendChild(nav);
}
function renderPage(page,anchor){
  const html=DOMPurify.sanitize(marked.parse(page.content,{headerIds:false}));
  $('#content').innerHTML=html;
  numberHeaders($('#content')); hljs.highlightAll();
  buildTOC(page); prevNext(page);
  anchor && document.getElementById(anchor)?.scrollIntoView({behavior:'smooth'});
}

/* --- graph  ------------------------------------------------------- */
function renderGraph(){
  const nodes=[],links=[]; pages.forEach((p,i)=>p._i=i);
  pages.forEach(p=>{nodes.push({id:p._i,label:p.title,ref:p}); p.parent&&links.push({source:p._i,target:p.parent._i});});
  const draw=id=>{
    const svg=d3.select('#'+id); svg.selectAll('*').remove();
    const w=svg.node().clientWidth||300,h=svg.node().clientHeight||200;
    const sim=d3.forceSimulation(nodes).force('link',d3.forceLink(links).id(d=>d.id).distance(80))
                .force('charge',d3.forceManyBody().strength(-230))
                .force('center',d3.forceCenter(w/2,h/2));
    svg.append('g').selectAll('line').data(links).join('line').attr('stroke','#555');
    const n=svg.append('g').selectAll('circle').data(nodes).join('circle')
      .attr('r',6).attr('fill',d=>d.ref.children.length?'#8a8a8a':'#569cd6')
      .call(d3.drag()
        .on('start',(e,d)=>{if(!e.active)sim.alphaTarget(.3).restart();d.fx=d.x;d.fy=d.y;})
        .on('drag',(e,d)=>{d.fx=e.x;d.fy=e.y;})
        .on('end',(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=d.fy=null;}))
      .on('click',(e,d)=>navigate(d.ref));
    const lab=svg.append('g').selectAll('text').data(nodes).join('text').attr('fill','#aaa').attr('font-size',10).text(d=>d.label);
    sim.on('tick',()=>{
      svg.selectAll('line').attr('x1',d=>d.source.x).attr('y1',d=>d.source.y)
                           .attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
      n.attr('cx',d=>d.x).attr('cy',d=>d.y);
      lab.attr('x',d=>d.x+8).attr('y',d=>d.y+3);
    });
  };
  draw('mini'); draw('full');       // mini + modal
}

/* =========================================================================
   3. Router
   ========================================================================= */
function route(){
  const parts=location.hash.slice(1).split('#').filter(Boolean);
  const page=findByPath(parts);                 // toujours valide (au pire = home)
  const anchor=parts.slice(hashOf(page).split('#').length).join('#');
  breadcrumb(page); renderPage(page,anchor);
}
/* utils */
function $$(sel,sc=document){return [...sc.querySelectorAll(sel)];}
</script>
</body>
</html>
