<!DOCTYPE html>
<!--
  km – Static Wiki  •  Slim-runtime UPDATED (Aug 2025)
  • user-defined graph palette (in config.js)
  • keeps first two tree levels open
  • memoised KaTeX loader
  • safer drag-start so graph doesn’t “explode” on first click
-->
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>km – Static Wiki</title>

  <!-- ─────────────  3ʳ-party CSS  ───────────── -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <link rel="stylesheet" href="km.css">

  <!--  Config (title, favicon, md bundle path, graph palette)  -->
  <script src="config.js"></script>
  <link id="favicon-el" rel="icon" href="">

  <!-- ─────────────  Runtime-loader  ───────────── -->
  <script type="module">
    /* ---- 1. Tiny D3 subset ---- */
    import { select, selectAll }                      from 'https://cdn.jsdelivr.net/npm/d3-selection@3/+esm';
    import { forceSimulation, forceLink,
             forceManyBody, forceCenter }             from 'https://cdn.jsdelivr.net/npm/d3-force@3/+esm';
    import { drag }                                   from 'https://cdn.jsdelivr.net/npm/d3-drag@3/+esm';
    window.d3 = { select, selectAll, forceSimulation, forceLink, forceManyBody, forceCenter, drag };

    /* ---- 2. highlight.js core + chosen languages ---- */
    const ensureHighlight = (() => {
      let ready;                                 // memoised Promise
      return function () {
        if (ready) return ready;                 // already loading / loaded

        ready = (async () => {
          const { LANGS = [] } = window.CONFIG;

          const hljs = (await import(
            'https://cdn.jsdelivr.net/npm/highlight.js@11/es/core/+esm'
          )).default;

          await Promise.all(
            LANGS.map(async lang => {
              const mod = await import(
                `https://cdn.jsdelivr.net/npm/highlight.js@11/es/languages/${lang}/+esm`
              );
              hljs.registerLanguage(lang, mod.default);
            })
          );

          window.hljs = hljs;                    // expose globally
        })();

        return ready;
      };
    })();

    // expose the loader so other modules can call it
    window.ensureHighlight = ensureHighlight;
  </script>
</head>

<body>
<!-- ─────────────  Sidebar  ───────────── -->
<aside id="sidebar" role="navigation" aria-label="Site">
  <a href="#" title="Home"><h1 id="wiki-title" tabindex="0"></h1></a>

  <div id="search-box">
    <input id="search" placeholder="Search…" autocomplete="off" aria-label="Search">
    <button id="search-clear" aria-label="Clear search" title="Clear search" style="display:none">✕</button>
  </div>

  <ul id="tree"></ul>
  <ul id="results"></ul>
</aside>

<!-- ─────────────  Main panel  ───────────── -->
<main>
  <header id="crumb" role="navigation" aria-label="Breadcrumb">
    <button id="burger-sidebar" class="burger" aria-label="Open sidebar">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </button>

    <a id="home-link" href="#" title="Home">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="grey"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </a>

    <span id="crumb-dyn"></span>

    <button id="burger-util" class="burger" aria-label="Open utility panel">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
    </button>
  </header>

  <div id="content-area">
    <article id="content"></article>

    <section id="util">
      <div id="graph-box">
        <svg id="mini"></svg>
        <button id="expand" aria-label="Open full graph">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="grey"><path d="M10 2a8 8 0 105.29 14.29l4.7 4.7 1.42-1.42-4.7-4.7A8 8 0 0010 2zm0 2a6 6 0 110 12A6 6 0 0110 4z"/></svg>
        </button>
      </div>

      <a class="watermark" href="https://github.com/erw-1/km" rel="noopener noreferrer">Powered by KM</a>
      <nav id="toc" aria-label="Table of contents"></nav>
    </section>
  </div>
</main>

<!-- Full-screen graph modal -->
<div id="modal">
  <span class="close" role="button" aria-label="Close full graph">✕</span>
  <svg id="full"></svg>
</div>

<!-- ───────────────────────────────────────────────
     Main application script ― now a MODULE
───────────────────────────────────────────────── -->
<script type="module">
  /* ---------- helpers ---------- */
  const $  = (s,c=document)=>(c||document).querySelector(s);
  const $$ = (s,c=document)=>[...(c||document).querySelectorAll(s)];

  /* ---------- config ---------- */
  const { TITLE, FAVICON, MD, GRAPH_COLORS } = window.CONFIG;  // palette comes straight from user config

  /* ---------- dynamic-imports ---------- */
  let mdReady=null;
  const ensureMarkdown = () => {
    if (!mdReady) {
      mdReady = Promise.all([
        import('https://cdn.jsdelivr.net/npm/marked@5/lib/marked.esm.js'),
        import('https://cdn.jsdelivr.net/npm/dompurify@3/+esm')
      ]).then(([m,dp]) => ({
        parse   : (src,opt)=>m.marked.parse(src,{...opt,mangle:false}),
        sanitize: html => dp.default.sanitize(html,{
          ADD_TAGS :['iframe'],
          ADD_ATTR :['allow','allowfullscreen','frameborder','scrolling',
                     'width','height','src','title'],
          ALLOWED_URI_REGEXP:/^(?:https?:|mailto:|tel:|#).*$/i,
        })
      }));
    }
    return mdReady;
  };

  /* ---- KaTeX lazy-loader (memoised) ---- */
  const ensureKatex = (() => {
    let ready;
    return function () {
      if (ready) return ready;
      ready = import('https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.mjs')
        .then(mod => { window.renderMathInElement = mod.default; });
      return ready;
    };
  })();

  /* ---------- page model ---------- */
  const pages=[], byId=new Map(); let root=null;

  fetch(MD,{cache:'force-cache'}).then(r=>r.text()).then(txt=>{
    for (const [,hdr,body] of txt.matchAll(/<!--([\s\S]*?)-->\s*([\s\S]*?)(?=<!--|$)/g)) {
      const meta={};
      hdr.replace(/(\w+):"([^"]+)"/g,(_,k,v)=>(meta[k]=v.trim()));
      pages.push({...meta,content:body.trim(),children:[]});
    }

    pages.forEach(p=>byId.set(p.id,p));
    root = byId.get('home') || pages[0];

    pages.forEach(p=>{
      if (p!==root) {
        const par = byId.get(p.parent) || root;
        p.parent  = par;
        par.children.push(p);
      }
    });

    const wordRE=/\p{L}+/gu;
    pages.forEach(p=>{
      p.tagsSet = new Set((p.tags||'').split(',').filter(Boolean));
      p.wordSet = new Set((p.title+' '+[...p.tagsSet].join(' ')+' '+p.content)
                          .toLowerCase().match(wordRE)||[]);
      p.searchStr = (p.title+' '+[...p.tagsSet].join(' ')+' '+p.content).toLowerCase();
    });

    initUI();
  });

  /* ---------- url helpers ---------- */
  const hashOf = p => { const a=[]; for (let n=p;n&&n.parent;n=n.parent) a.unshift(n.id); return a.join('#'); };
  const find   = segs => { let n=root; for (const id of segs) { const c=n.children.find(k=>k.id===id); if(!c) break; n=c; } return n; };
  const nav    = p => (location.hash='#'+hashOf(p));

  /* ---------- UI boot-strap ---------- */
  function initUI() {
    $('#wiki-title').textContent = TITLE;
    document.title               = TITLE;
    $('#favicon-el').href        = FAVICON;

    buildTree(); route();

    new IntersectionObserver((e,o)=>{ if(e[0].isIntersecting){buildGraph();o.disconnect();} })
      .observe($('#mini'));

    addEventListener('hashchange',route);
    $('#expand').onclick = ()=>{ $('#modal').classList.add('open'); buildGraph(); };
    $('#modal .close').onclick = ()=>$('#modal').classList.remove('open');

    const searchInput = $('#search');
    const searchClear = $('#search-clear');
    let t=0;
    searchInput.oninput = e => {
      clearTimeout(t);
      const v=e.target.value;
      searchClear.style.display = v ? '' : 'none';
      t = setTimeout(()=>search(v.toLowerCase()),150);
    };
    searchClear.onclick = () => {
      searchInput.value = '';
      searchClear.style.display = 'none';
      search('');
      searchInput.focus();
    };

    const toggle = sel => {
      const el=$(sel);
      const o = el.classList.toggle('open');
      if(o && !el.querySelector('.panel-close')){
        const btn = document.createElement('button');
        btn.className='panel-close';
        btn.textContent='✕';
        btn.onclick=()=>el.classList.remove('open');
        el.appendChild(btn);
      }
    };
    $('#burger-sidebar').onclick = ()=>toggle('#sidebar');
    $('#burger-util').onclick    = ()=>toggle('#util');
    addEventListener('resize',()=>{ if(matchMedia('(min-width:1001px)').matches){ $('#sidebar').classList.remove('open'); $('#util').classList.remove('open'); }});
  }

  /* -------------------------------------------------------
     SECTION 3 • Sidebar tree build  (first 2 levels open)
  ---------------------------------------------------- */
  function buildTree() {
    const ul = $('#tree');
    ul.innerHTML = '';

    const rec = (lst, container, depth=0) => {
      lst.sort((a,b)=>a.title.localeCompare(b.title));
      lst.forEach(p=>{
        const li = document.createElement('li');

        if (p.children.length) {
          const isOpen = depth < 2;                  // open first two levels
          li.className = 'folder' + (isOpen ? ' open':'');
          const caret  = document.createElement('button');
          caret.className = 'caret';
          caret.setAttribute('aria-expanded', String(isOpen));
          caret.onclick = e=>{
            e.stopPropagation();
            const open = li.classList.toggle('open');
            caret.setAttribute('aria-expanded', String(open));
            sub.style.display = open ? 'block':'none';
          };

          const lbl = document.createElement('a');
          lbl.className = 'lbl';
          lbl.href      = '#' + hashOf(p);
          lbl.textContent = p.title;
          lbl.addEventListener('keydown', e=>{
            if(e.key==='Enter'||e.key===' '){ e.preventDefault(); nav(p); }
          });

          const sub = document.createElement('ul');
          sub.style.display = isOpen ? 'block':'none';

          li.append(caret,lbl,sub);
          container.appendChild(li);
          rec(p.children,sub,depth+1);
        } else {
          li.className='article';
          const a = document.createElement('a');
          a.href  = '#' + hashOf(p);
          a.textContent = p.title;
          li.appendChild(a);
          container.appendChild(li);
        }
      });
    };
    rec(root.children,ul,0);
  }

  /* -------------------------------------------------------
     SECTION 4 • Search (substring match, min 2 chars)
  ---------------------------------------------------- */
  function search(q) {
    const qUl = $('#results');
    const tUl = $('#tree');
    if(!q.trim()){ qUl.style.display='none'; tUl.style.display=''; return; }

    const tokens = q.split(/\s+/).filter(tok=>tok.length>=2);
    qUl.innerHTML=''; qUl.style.display=''; tUl.style.display='none';

    pages.filter(p=>tokens.every(tok=>p.searchStr.includes(tok))).forEach(p=>{
      const li=document.createElement('li');
      li.setAttribute('role','option');
      li.textContent=p.title;
      li.onclick=()=>nav(p);
      qUl.appendChild(li);
    });
    if(!qUl.children.length) qUl.innerHTML='<li id="no_result">No result</li>';
  }

  /* -------------------------------------------------------
     SECTION 5 • Breadcrumb
  ---------------------------------------------------- */
  function breadcrumb(p) {
    const dyn = $('#crumb-dyn');
    dyn.innerHTML='';

    const chain=[];
    for(let n=p;n;n=n.parent) chain.unshift(n);
    chain.shift();

    chain.forEach(n=>{
      dyn.insertAdjacentHTML('beforeend','<span class="separator">▸</span>');

      const wrap = document.createElement('span');
      wrap.className='dropdown';

      const a=document.createElement('a');
      a.textContent=n.title;
      a.href='#'+hashOf(n);
      if(n===p) a.className='crumb-current';
      wrap.appendChild(a);

      const sib=n.parent.children;
      if(sib.length>1){
        const ul=document.createElement('ul');
        sib.forEach(s=>{
          const li=document.createElement('li');
          li.textContent=s.title;
          li.onclick=()=>nav(s);
          ul.appendChild(li);
        });
        wrap.appendChild(ul);
      }
      dyn.appendChild(wrap);
    });

    if(p.children.length){
      const box=document.createElement('span');
      box.className='childbox';
      box.innerHTML='<span class="toggle">▾</span><ul></ul>';

      const ul=box.querySelector('ul');
      p.children.sort((a,b)=>a.title.localeCompare(b.title)).forEach(ch=>{
        const li=document.createElement('li');
        li.textContent=ch.title;
        li.onclick=()=>nav(ch);
        ul.appendChild(li);
      });
      dyn.appendChild(box);
    }
  }

  /* -------------------------------------------------------
     SECTION 6 • Markdown render + ToC + prev/next
  ---------------------------------------------------- */
  function numHead(el){
    const c=[0,0,0,0,0,0];
    $$('h1,h2,h3,h4,h5',el).forEach(h=>{
      const l=+h.tagName[1]-1;
      c[l]++; for(let i=l+1;i<6;i++) c[i]=0;
      h.id=c.slice(0,l+1).filter(Boolean).join('_');
    });
  }

  function toc(pg){
    const nav=$('#toc'); nav.innerHTML='';
    const hd=$$('#content h1,#content h2,#content h3');
    if(!hd.length) return;
    const ul=document.createElement('ul');
    hd.forEach(h=>{
      const li=document.createElement('li');
      li.dataset.level=h.tagName[1];
      const a=document.createElement('a');
      const base=hashOf(pg);
      a.href='#'+(base?base+'#':'')+h.id;
      a.textContent=h.textContent;
      li.appendChild(a); ul.appendChild(li);
    });
    nav.appendChild(ul);
  }

  function prevNext(pg){
    $('#prev-next')?.remove();
    if(!pg.parent) return;
    const sib=pg.parent.children; if(sib.length<2) return;
    const i=sib.indexOf(pg);
    const nav=document.createElement('div'); nav.id='prev-next';
    if(i>0) nav.appendChild(Object.assign(document.createElement('a'),{href:'#'+hashOf(sib[i-1]),textContent:'← '+sib[i-1].title}));
    if(i<sib.length-1) nav.appendChild(Object.assign(document.createElement('a'),{href:'#'+hashOf(sib[i+1]),textContent:sib[i+1].title+' →'}));
    $('#content').appendChild(nav);
  }

  async function render(pg,anc){
    const {parse,sanitize}=await ensureMarkdown();
    $('#content').innerHTML=sanitize(parse(pg.content,{headerIds:false}));

    numHead($('#content'));

    await window.ensureHighlight();
    window.hljs.highlightAll();

    if(/\$[^$]+\$|\\\(|\\\[/.test(pg.content)){
      await ensureKatex();
      window.renderMathInElement($('#content'),{
        delimiters:[
          {left:'$$',right:'$$',display:true},
          {left:'\\[',right:'\\]',display:true},
          {left:'$', right:'$', display:false},
          {left:'\\(',right:'\\)',display:false}],
        throwOnError:false
      });
    }

    toc(pg); prevNext(pg);
    if(anc) document.getElementById(anc)?.scrollIntoView({behavior:'smooth'});
  }

  /* -------------------------------------------------------
     SECTION 7 • Graph (mini & modal)
  ---------------------------------------------------- */
  function buildGraphData(){
    const nodes=[],links=[],adj=new Map();
    pages.forEach((p,i)=>(p._i=i));

    pages.forEach(p=>{
      nodes.push({id:p._i,label:p.title,ref:p});
      if(p.parent){
        links.push({source:p._i,target:p.parent._i,kind:'hier'});
        addAdj(p._i,p.parent._i);
      }
    });

    const tagMap=new Map();
    pages.forEach(p=>p.tagsSet.forEach(t=>{
      if(!tagMap.has(t)) tagMap.set(t,[]);
      tagMap.get(t).push(p);
    }));
    tagMap.forEach(list=>{
      for(let i=0;i<list.length;i++)
        for(let j=i+1;j<list.length;j++){
          const a=list[i],b=list[j];
          if(!adj.get(a._i)?.has(b._i)){
            links.push({source:a._i,target:b._i,kind:'tag'});
            addAdj(a._i,b._i);
          }
        }
    });

    function addAdj(a,b){
      if(!adj.has(a)) adj.set(a,new Set());
      if(!adj.has(b)) adj.set(b,new Set());
      adj.get(a).add(b); adj.get(b).add(a);
    }
    return {nodes,links,adj};
  }

  function buildGraph(){
    const {nodes,links,adj}=buildGraphData();

    ['mini','full'].forEach(id=>{
      const svg=d3.select('#'+id);
      svg.selectAll('*').remove();
      const full=(id==='full');
      const w=svg.node().clientWidth  || 300;
      const h=svg.node().clientHeight || 200;

      /* make local copies so simulations don’t share state */
      const localNodes=nodes.map(n=>({...n}));
      const localLinks=links.map(l=>({source:l.source,target:l.target,kind:l.kind}));

      const sim=d3.forceSimulation(localNodes)
        .force('link',d3.forceLink(localLinks).id(d=>d.id).distance(80))
        .force('charge',d3.forceManyBody().strength(-240))
        .force('center',d3.forceCenter(w/2,h/2));

      const link=svg.append('g').selectAll('line').data(localLinks).join('line')
        .attr('stroke', d => d.kind==='tag'
              ? GRAPH_COLORS.tag
              : GRAPH_COLORS.hier)
        .attr('stroke-width',1);

      const node = svg.append('g')
        .selectAll('circle').data(localNodes).join('circle')
        .attr('r', 6)
        .attr('fill', d => d.ref.children.length
              ? GRAPH_COLORS.parent
              : GRAPH_COLORS.leaf)
        .style('cursor', 'pointer')
        .on('click', (e, d) => {               // navigate on click
          nav(d.ref);
          if (full) $('#modal').classList.remove('open');
        })
        .on('mouseover', (e, d) => highlight(d.id, 0.15))
        .on('mouseout',  ()    => highlight(null, 1))
        .call(
          d3.drag()
            /* keep the grab-point but don’t poke the sim yet            */
            .on('start', (e, d) => { d.fx = d.x; d.fy = d.y; })
            /* only kick the simulation once the pointer actually moves  */
            .on('drag',  (e, d) => {
              if (e.dx || e.dy) sim.alphaTarget(0.3).restart();
              d.fx = e.x; d.fy = e.y;
            })
            /* release and let the layout cool when done                 */
            .on('end',   (e, d) => {
              if (!e.active) sim.alphaTarget(0);
              d.fx = d.fy = null;
            })
        );

      const label=svg.append('g').selectAll('text').data(localNodes).join('text')
        .attr('fill', GRAPH_COLORS.label)
        .attr('font-size',10).text(d=>d.label);

      function highlight(id,fade){
        node.style('opacity',o=>id==null||adj.get(id)?.has(o.id)||o.id===id?1:fade);
        link.style('opacity',l=>id==null||l.source.id===id||l.target.id===id?1:fade);
        label.style('opacity',o=>id==null||adj.get(id)?.has(o.id)||o.id===id?1:fade);
      }

      sim.on('tick',()=>{
        link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y)
            .attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
        node.attr('cx',d=>d.x).attr('cy',d=>d.y);
        label.attr('x',d=>d.x+8).attr('y',d=>d.y+3);
      });
    });
  }

  /* -------------------------------------------------------
     SECTION 8 • Client-side routing
  ---------------------------------------------------- */
  function route(){
    const seg=location.hash.slice(1).split('#').filter(Boolean);
    const pg=find(seg);
    const anc=seg.slice(hashOf(pg).split('#').length).join('#');
    document.documentElement.scrollTop=0;
    document.body.scrollTop=0;
    breadcrumb(pg); render(pg,anc);
  }
</script>
</body>
</html>
