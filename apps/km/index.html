<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>km – Static Wiki</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css"/>

<style>
:root{--bg:#1e1e1e;--bg-alt:#2a2a2a;--fg:#d4d4d4;--accent:#569cd6;}
*{box-sizing:border-box;margin:0}
body{height:100vh;display:flex;background:var(--bg);color:var(--fg);
     font-family:system-ui,Segoe UI,Roboto,sans-serif;overflow:hidden}

/* ── SIDEBAR (inchangé) ───────────────────────────────────────────── */
#sidebar{width:260px;background:var(--bg-alt);padding:.6rem .5rem;border-right:1px solid #444;overflow-y:auto}
#search{width:100%;padding:.35rem .6rem;margin-bottom:.5rem;border:none;border-radius:6px;background:#3a3a3a;color:var(--fg)}
#sidebar ul{list-style:none;margin:0}
#sidebar li{margin:.15rem 0;cursor:pointer} #sidebar li:hover{color:var(--accent)}
.caret{display:inline-block;width:14px;margin-right:2px;cursor:pointer;transition:.2s}
.caret::before{content:"▸"} .folder.open>.caret{transform:rotate(90deg)}
#sidebar ul ul{padding-left:1.1em;position:relative}
#sidebar ul ul::before{content:'';position:absolute;top:0;bottom:0;left:0;width:1px;background:#555;opacity:.6}

/* ── BREADCRUMB + dropdowns ───────────────────────────────────────── */
header{height:48px;background:var(--bg-alt);display:flex;align-items:center;gap:.5rem;padding:0 1rem}
header a{color:var(--fg);text-decoration:none;padding:4px 8px;border-radius:6px;display:flex;align-items:center;gap:4px}
header a:hover{background:#3a3a3a}.crumb-current{background:#3a3a3a}
.separator{margin:0 .25rem}
.drop{position:relative;display:inline-flex;align-items:center}
.drop ul{display:none;position:absolute;top:100%;left:0;background:#3a3a3a;border-radius:4px;
        padding:.25rem 0;list-style:none;min-width:160px;z-index:40}
.drop:hover ul{display:block}
.drop li{padding:6px 12px;white-space:nowrap;cursor:pointer}
.drop li:hover{background:var(--accent)}
.child-toggle{cursor:pointer;padding:4px;margin-left:2px}
.child-toggle:hover{color:var(--accent)}

/* ── LAYOUT / CONTENT / GRAPH ─────────────────────────────────────── */
#content-area{flex:1;display:flex;overflow:hidden}
#content{flex:1;overflow-y:auto;padding:1rem 2rem}              /* max‑width retiré */
#content h1,#content h2,#content h3{scroll-margin-top:70px}
#prev-next{display:flex;justify-content:space-between;margin:2rem 0}
#prev-next a{background:#3a3a3a;color:var(--fg);padding:.6rem 1rem;border-radius:6px;text-decoration:none}
#prev-next a:hover{background:var(--accent)}

#util{width:300px;background:var(--bg);padding:.75rem .5rem;border-left:1px solid #444;display:flex;flex-direction:column;gap:1rem}
#graph-box{height:240px;border:1px solid #333;border-radius:8px;position:relative}
#graph-box svg{width:100%;height:100%}
#toc{flex:1;border:1px solid #333;border-radius:8px;padding:.5rem;overflow:auto}
#toc li[data-level="2"]{padding-left:14px}#toc li[data-level="3"]{padding-left:28px}
#toc a{color:var(--accent);text-decoration:none}

#modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:.2s}
#modal.open{opacity:1;visibility:visible}
#modal .close{position:absolute;top:1rem;right:1rem;font-size:2rem;color:#fff;cursor:pointer}
#modal svg{width:80vw;height:80vh}
</style>
</head>

<body>
<aside id="sidebar">
  <input id="search" placeholder="Search…" autocomplete="off">
  <ul id="tree"></ul>
  <ul id="results" style="display:none"></ul>
</aside>

<main>
  <header id="crumb"></header>
  <div id="content-area">
    <article id="content"></article>
    <section id="util">
      <div id="graph-box"><svg id="mini"></svg>
        <button id="expand" style="position:absolute;top:8px;right:8px">🔍</button>
      </div>
      <nav id="toc"></nav>
    </section>
  </div>
</main>

<div id="modal"><span class="close">✕</span><svg id="full"></svg></div>

<script>
/* ------------------------- loader/store --------------------------- */
const MD='content.md';const pages=[],byId=new Map();let root=null;
fetch(MD).then(r=>r.text()).then(t=>{
  for(const[,h,b]of t.matchAll(/<!--([\s\S]*?)-->\s*([\s\S]*?)(?=<!--|$)/g)){
    const m={};h.replace(/(\w+):"([^"]+)"/g,(_,k,v)=>m[k]=v.trim());pages.push({...m,content:b.trim(),children:[]});}
  pages.forEach(p=>byId.set(p.id,p));root=byId.get('home')||pages[0];
  pages.forEach(p=>{if(p!==root){const par=byId.get(p.parent)||root;p.parent=par;par.children.push(p);} });
  pages.forEach(p=>{p.tagsSet=new Set((p.tags||'').split(',').filter(Boolean));
    p.searchText=(p.title+' '+[...p.tagsSet].join(' ')+p.content).toLowerCase();});
  initUI();
});
const hashOf=p=>{const a=[];for(let n=p;n&&n.parent;n=n.parent)a.unshift(n.id);return a.join('#');};
const find=arr=>{let n=root;for(const id of arr){const c=n.children.find(k=>k.id===id);if(!c)break;n=c;}return n;};
const nav=p=>location.hash='#'+hashOf(p);
const $=(s,sc=document)=>sc.querySelector(s), $$=(s,sc=document)=>[...sc.querySelectorAll(s)];

/* ------------------------- UI ------------------------------------ */
function initUI(){buildTree();graph();route();
  addEventListener('hashchange',route);
  $('#expand').onclick=()=>$('#modal').classList.add('open');
  $('#modal .close').onclick=()=>$('#modal').classList.remove('open');
  let t=0;$('#search').oninput=e=>{clearTimeout(t);t=setTimeout(()=>search(e.target.value.toLowerCase()),150);};}

/* --- tree */
function buildTree(){
  const ul=$('#tree');ul.innerHTML='';
  const rec=(lst,u)=>{lst.sort((a,b)=>a.title.localeCompare(b.title));
    lst.forEach(p=>{
      const li=document.createElement('li');
      if(p.children.length){
        li.className='folder open';
        li.innerHTML=`<span class="caret"></span><span class="lbl">${p.title}</span><ul></ul>`;
        const caret=li.querySelector('.caret'),lbl=li.querySelector('.lbl'),sub=li.querySelector('ul');sub.style.display='block';
        caret.onclick=e=>{e.stopPropagation();const o=li.classList.toggle('open');sub.style.display=o?'block':'none';};
        lbl.onclick=()=>nav(p);rec(p.children,sub);
      }else{li.textContent=p.title;li.onclick=()=>nav(p);}
      u.appendChild(li);
    });};
  rec(root.children,ul);
}

/* --- search (inchangé) */
function search(q){const t=$('#tree'),r=$('#results');
  if(!q){r.style.display='none';t.style.display='';return;}
  r.innerHTML='';r.style.display='';t.style.display='none';
  pages.filter(p=>p.searchText.includes(q)).forEach(p=>{
    const li=document.createElement('li');li.textContent=p.title;li.onclick=()=>nav(p);r.appendChild(li);});
  if(!r.children.length)r.innerHTML='<li style="opacity:.6">No result</li>';
}

/* --- breadcrumb avec children menu -------------------------------- */
function breadcrumb(p){
  const h=$('#crumb');h.innerHTML='';
  h.innerHTML=`<a href="#" title="Home">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
  </a>`;
  const chain=[];for(let n=p;n;n=n.parent)chain.unshift(n);chain.shift();
  chain.forEach((n,i)=>{
    h.insertAdjacentHTML('beforeend','<span class="separator">></span>');
    /* bloc siblings -------------------------------------------------- */
    const siblingWrap=document.createElement('span');siblingWrap.className='drop';
    const link=document.createElement('a');link.textContent=n.title;link.href='#'+hashOf(n);
    if(i===chain.length-1)link.className='crumb-current';siblingWrap.appendChild(link);
    const sib=n.parent.children;if(sib.length>1){
      const ul=document.createElement('ul');
      sib.forEach(s=>{const li=document.createElement('li');li.textContent=s.title;li.onclick=()=>nav(s);ul.appendChild(li);});
      siblingWrap.appendChild(ul);
    }
    h.appendChild(siblingWrap);

    /* bloc enfants (seulement pour la page courante) ----------------- */
    if(i===chain.length-1 && n.children.length){
      const childWrap=document.createElement('span');childWrap.className='drop';
      childWrap.innerHTML='<span class="child-toggle">▾</span><ul></ul>';
      const ul=childWrap.querySelector('ul');
      n.children.sort((a,b)=>a.title.localeCompare(b.title)).forEach(ch=>{
        const li=document.createElement('li');li.textContent=ch.title;li.onclick=()=>nav(ch);ul.appendChild(li);});
      h.appendChild(childWrap);
    }
  });
}

/* --- markdown / toc / prev-next (inchangés) ----------------------- */
function numHead(el){const c=[0,0,0,0,0,0];$$('h1,h2,h3,h4,h5',el).forEach(h=>{const l=+h.tagName[1]-1;c[l]++;for(let i=l+1;i<6;i++)c[i]=0;h.id=c.slice(0,l+1).filter(Boolean).join('_');});}
function toc(pg){const nav=$('#toc');nav.innerHTML='';const hd=$$('#content h1,#content h2,#content h3');if(!hd.length)return;
  const ul=document.createElement('ul');hd.forEach(h=>{const li=document.createElement('li');li.dataset.level=h.tagName[1];
    const a=document.createElement('a');a.href='#'+hashOf(pg)+'#'+h.id;a.textContent=h.id+'  '+h.textContent;li.appendChild(a);ul.appendChild(li);});
  nav.appendChild(ul);}
function prevNext(pg){$('#prev-next')?.remove();if(!pg.parent)return;const sib=pg.parent.children;if(sib.length<2)return;
  const i=sib.indexOf(pg),nav=document.createElement('div');nav.id='prev-next';
  if(i>0)nav.appendChild(Object.assign(document.createElement('a'),{href:'#'+hashOf(sib[i-1]),textContent:'← '+sib[i-1].title}));
  if(i<sib.length-1)nav.appendChild(Object.assign(document.createElement('a'),{href:'#'+hashOf(sib[i+1]),textContent:sib[i+1].title+' →'}));
  $('#content').appendChild(nav);}
function render(pg,anc){$('#content').innerHTML=DOMPurify.sanitize(marked.parse(pg.content,{headerIds:false}));
  numHead($('#content'));hljs.highlightAll();toc(pg);prevNext(pg);if(anc)document.getElementById(anc)?.scrollIntoView({behavior:'smooth'});}

/* --- graph (inchangé) -------------------------------------------- */
function graph(){const n=[],l=[];pages.forEach((p,i)=>p._i=i);
  pages.forEach(p=>{n.push({id:p._i,label:p.title,ref:p});p.parent&&l.push({source:p._i,target:p.parent._i});});
  ['mini','full'].forEach(id=>{
    const svg=d3.select('#'+id);svg.selectAll('*').remove();const w=svg.node().clientWidth||300,h=svg.node().clientHeight||200;
    const sim=d3.forceSimulation(n).force('link',d3.forceLink(l).id(d=>d.id).distance(80))
                .force('charge',d3.forceManyBody().strength(-240))
                .force('center',d3.forceCenter(w/2,h/2));
    svg.append('g').selectAll('line').data(l).join('line').attr('stroke','#555');
    const nd=svg.append('g').selectAll('circle').data(n).join('circle')
      .attr('r',6).attr('fill',d=>d.ref.children.length?'#8a8a8a':'#569cd6')
      .on('click',(e,d)=>nav(d.ref))
      .call(d3.drag().on('start',(e,d)=>{if
(!e.active)sim.alphaTarget(.3).restart();d.fx=d.x;d.fy=d.y;})
                     .on('drag',(e,d)=>{d.fx=e.x;d.fy=e.y;})
                     .on('end',(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=d.fy=null;}));
    const lbl=svg.append('g').selectAll('text').data(n).join('text').attr('fill','#aaa').attr('font-size',10).text(d=>d.label);
    sim.on('tick',()=>{svg.selectAll('line').attr('x1',d=>d.source.x).attr('y1',d=>d.source.y)
                       .attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
      nd.attr('cx',d=>d.x).attr('cy',d=>d.y);lbl.attr('x',d=>d.x+8).attr('y',d=>d.y+3);});
  });}

/* --- router ------------------------------------------------------- */
function route(){const seg=location.hash.slice(1).split('#').filter(Boolean);
  const pg=find(seg);const anc=seg.slice(hashOf(pg).split('#').length).join('#');
  breadcrumb(pg);render(pg,anc);}
</script>
</body>
</html>
