<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>km – Static Wiki</title>
    <!-- 📚 3rd-party libs (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/common.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github-dark.min.css"
    />

    <style>
      /* ─── Generic reset & dark theme similar to Obsidian ────────────────── */
      :root {
        --bg: #1e1e1e;
        --bg-alt: #2a2a2a;
        --fg: #d4d4d4;
        --accent: #569cd6;
        --shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        color: var(--fg);
        display: flex;
        min-height: 100vh;
        overflow: hidden;
      }

      /* ─── Sidebar (tree) ─────────────────────────────────────────────────── */
      #sidebar {
        width: 260px;
        background: var(--bg-alt);
        padding: 0.5rem;
        overflow-y: auto;
        border-right: 1px solid #444;
      }
      #sidebar ul {
        list-style: none;
        padding-left: 0.6em;
      }
      #sidebar li {
        margin: 0.15em 0;
        cursor: pointer;
      }
      #sidebar li:hover {
        color: var(--accent);
      }
      .folder > span::before {
        content: "▸";
        display: inline-block;
        margin-right: 4px;
        transition: transform 0.2s;
      }
      .folder.open > span::before {
        transform: rotate(90deg);
      }

      /* ─── Main layout ───────────────────────────────────────────────────── */
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* ─── Header / breadcrumb ───────────────────────────────────────────── */
      header {
        background: var(--bg-alt);
        padding: 0 1rem;
        display: flex;
        align-items: center;
        height: 48px;
        gap: 0.5rem;
        box-shadow: var(--shadow);
        user-select: none;
      }
      header a, header span {
        color: var(--fg);
        text-decoration: none;
        display: flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 6px;
      }
      header a:hover {
        background: #3a3a3a;
      }
      header .crumb-current {
        background: #3a3a3a;
        cursor: default;
      }
      header .separator {
        margin: 0 0.25rem;
      }

      /* Dropdown */
      .dropdown {
        position: relative;
      }
      .dropdown ul {
        display: none;
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        background: #3a3a3a;
        border-radius: 4px;
        padding: 0.25rem 0;
        list-style: none;
        min-width: 160px;
        z-index: 10;
      }
      .dropdown ul li {
        padding: 6px 12px;
        white-space: nowrap;
      }
      .dropdown ul li:hover {
        background: var(--accent);
      }
      .dropdown:hover ul {
        display: block;
      }

      /* ─── Utility panes (graph + ToC) ───────────────────────────────────── */
      #utility-bar {
        display: flex;
        gap: 1rem;
        padding: 0.5rem 1rem;
        background: var(--bg);
        border-bottom: 1px solid #444;
      }
      #graph-container {
        flex: 1;
        min-height: 220px;
        position: relative;
        border: 1px solid #333;
        border-radius: 8px;
      }
      #toc {
        width: 240px;
        max-height: 220px;
        overflow: auto;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 0.5rem;
      }
      #toc ul {
        list-style: none;
        padding-left: 0.6em;
      }
      #toc li {
        margin: 0.2rem 0;
      }
      #toc a {
        color: var(--accent);
        text-decoration: none;
      }

      /* ─── Markdown content ─────────────────────────────────────────────── */
      #content-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 1rem 2rem;
        max-width: 960px;
        margin: 0 auto;
      }
      #content-wrapper h1, h2, h3, h4, h5 {
        scroll-margin-top: 70px;
      }
      #prev-next {
        display: flex;
        justify-content: space-between;
        margin: 2rem 0;
      }
      #prev-next a {
        background: #3a3a3a;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        color: var(--fg);
        text-decoration: none;
      }
      #prev-next a:hover {
        background: var(--accent);
      }

      /* ─── Graph modal ──────────────────────────────────────────────────── */
      #graph-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 20;
      }
      #graph-modal.open {
        visibility: visible;
        opacity: 1;
      }
      #graph-modal .close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2rem;
        cursor: pointer;
        color: #fff;
      }
      #graph-modal svg {
        width: 80vw;
        height: 80vh;
      }

      /* Scrollbar tweaks */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-alt);
      }
      ::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #666;
      }
    </style>
  </head>
  <body>
    <!-- ───────────────────────────────────────────────── SIDEBAR ────── -->
    <aside id="sidebar"></aside>

    <!-- ─────────────────────────────────────────────────── MAIN ─────── -->
    <main>
      <header id="breadcrumb"></header>

      <section id="utility-bar">
        <div id="graph-container">
          <svg id="mini-graph"></svg>
          <button id="expand-graph" title="Agrandir le graphe" style="position:absolute;top:8px;right:8px">🔍</button>
        </div>
        <nav id="toc"></nav>
      </section>

      <article id="content-wrapper"></article>
    </main>

    <!-- ────────────────────────────────────────────────── MODAL ─────── -->
    <div id="graph-modal">
      <span class="close">✕</span>
      <svg id="full-graph"></svg>
    </div>

    <!-- ─────────────────────────────────────────────────── JS ───────── -->
    <script>
      /*
       * km – open-source, static, recursive Markdown wiki
       * Features:
       *  • GitHub repo scanning via REST API
       *  • Hash-based routing (#folder#sub#file)
       *  • Breadcrumb w/ dropdown siblings
       *  • Interactive D3.js graph (mini + modal)
       *  • GitHub-flavoured Markdown via marked + highlight.js
       *  • Previous/next navigation
       */

      const CONFIG = {
        user: "erw-1",
        repo: "erw.one",
        branch: "main",
        rootPath: "apps/km/content", // path in repo containing markdown folders
      };

      /* ─── Global state ─────────────────────────────────────────────── */
      let fileTree = null; // lazy-loaded
      let flatIndex = {};
      let currentNode = null;

      /* ─── Helpers ──────────────────────────────────────────────────── */
      const ghApiBase = `https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/contents/${CONFIG.rootPath}`;

      async function fetchDir(path = "") {
        const url = `${ghApiBase}/${path}?ref=${CONFIG.branch}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("GitHub API error " + res.status);
        return res.json();
      }

      async function buildFileTree(path = "", parent = null) {
        const items = await fetchDir(path);
        const node = {
          name: path.split("/").pop() || "home", // root becomes 'home'
          path,
          type: "folder",
          children: [],
          parent,
        };
        for (const item of items) {
          if (item.type === "dir") {
            const child = await buildFileTree(`${path}/${item.name}`, node);
            node.children.push(child);
          } else if (item.type === "file" && item.name.endsWith(".md")) {
            const rawUrl = item.download_url;
            const mdNode = {
              name: item.name.replace(/\.md$/i, ""),
              path: `${path}/${item.name}`,
              type: "file",
              raw: rawUrl,
              parent: node,
              id: null,
              title: null,
            };
            await parseFrontmatter(mdNode);
            node.children.push(mdNode);
            flatIndex[mdNode.id || mdNode.name] = mdNode;
          }
        }
        node.children.sort((a, b) => a.name.localeCompare(b.name));
        return node;
      }

      async function parseFrontmatter(node) {
        // only for files
        try {
          const text = await fetch(node.raw).then((r) => r.text());
          const firstLine = text.split("\n")[0];
          const m = firstLine.match(/<--\s*id:\s*"([^"]+)"\s*title:\s*"([^"]+)"\s*-->/);
          if (m) {
            node.id = m[1];
            node.title = m[2];
          }
        } catch (e) {
          console.error("frontmatter parse error", node.path, e);
        }
      }

      /* ─── Routing helpers ──────────────────────────────────────────── */
      function hashToPath() {
        const parts = decodeURIComponent(location.hash.slice(1)).split("#").filter(Boolean);
        if (parts.length === 0) return { pathArray: [], md: "home" };
        if (parts[parts.length - 1] === "") parts.pop();
        return { pathArray: parts };
      }

      function findNodeByHash(parts) {
        if (!fileTree) return null;
        if (parts.length === 0) return fileTree; // root/home
        let node = fileTree;
        for (let i = 0; i < parts.length; i++) {
          const part = parts[i];
          const child = node.children.find((c) => (c.id || c.name) === part);
          if (!child) return null;
          node = child;
        }
        return node;
      }

      /* ─── UI Rendering ─────────────────────────────────────────────── */
      function renderSidebar(node, container) {
        container.innerHTML = "";
        const ul = document.createElement("ul");
        container.appendChild(ul);
        buildSidebarRecursive(node, ul);
      }

      function buildSidebarRecursive(node, parentUl) {
        for (const child of node.children) {
          const li = document.createElement("li");
          parentUl.appendChild(li);
          if (child.type === "folder") {
            li.classList.add("folder");
            const span = document.createElement("span");
            span.textContent = child.name;
            li.appendChild(span);
            const innerUl = document.createElement("ul");
            li.appendChild(innerUl);
            span.onclick = () => {
              li.classList.toggle("open");
            };
            buildSidebarRecursive(child, innerUl);
          } else {
            li.textContent = child.title || child.name;
            li.onclick = () => {
              navigateTo(child);
            };
          }
        }
      }

      function renderBreadcrumb(node) {
        const header = document.getElementById("breadcrumb");
        header.innerHTML = "";
        const chain = [];
        let n = node;
        while (n) {
          chain.unshift(n);
          n = n.parent;
        }

        // Home icon
        const homeLink = document.createElement("a");
        homeLink.innerHTML = "🏠";
        homeLink.href = "#";
        header.appendChild(homeLink);

        chain.forEach((n, idx) => {
          if (idx === 0) return; // skip root because home icon
          const sep = document.createElement("span");
          sep.className = "separator";
          sep.textContent = ">";
          header.appendChild(sep);

          const hasSiblings = n.parent && n.parent.children.filter((c) => c.type === n.type).length > 1;
          const wrapper = document.createElement(hasSiblings ? "div" : "a");
          if (hasSiblings) wrapper.className = "dropdown";

          const link = document.createElement("a");
          link.textContent = n.title || n.name;
          link.className = idx === chain.length - 1 ? "crumb-current" : "";
          link.href = `#${chain.slice(1, idx + 1).map((p) => p.id || p.name).join("#")}`;

          if (!hasSiblings) {
            header.appendChild(link);
            return;
          }

          wrapper.appendChild(link);
          const ul = document.createElement("ul");
          for (const sib of n.parent.children.filter((c) => c.type === n.type)) {
            const li = document.createElement("li");
            li.textContent = sib.title || sib.name;
            li.onclick = () => navigateTo(sib);
            ul.appendChild(li);
          }
          wrapper.appendChild(ul);
          header.appendChild(wrapper);
        });
      }

      async function renderContent(node) {
        const contentWrapper = document.getElementById("content-wrapper");
        if (!node || node.type !== "file") {
          contentWrapper.innerHTML = "<p>Fichier introuvable.</p>";
          return;
        }
        const raw = await fetch(node.raw).then((r) => r.text());
        const md = raw.replace(/<--.*-->/, ""); // strip front-matter comment
        const html = marked.parse(md, { headerIds: true });
        contentWrapper.innerHTML = html;
        // highlight code blocks
        contentWrapper.querySelectorAll("pre code").forEach((el) => hljs.highlightElement(el));
        renderTOC();
        renderPrevNext(node);
      }

      function renderTOC() {
        const tocNav = document.getElementById("toc");
        tocNav.innerHTML = "";
        const headings = document.querySelectorAll("#content-wrapper h1, h2, h3");
        if (headings.length === 0) return;
        const list = document.createElement("ul");
        headings.forEach((h) => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = "#" + h.id;
          a.textContent = h.textContent;
          li.appendChild(a);
          list.appendChild(li);
        });
        tocNav.appendChild(list);
      }

      function renderPrevNext(node) {
        const container = document.getElementById("prev-next");
        if (container) container.remove();
        const siblings = node.parent.children.filter((c) => c.type === "file");
        if (siblings.length <= 1) return;
        const idx = siblings.indexOf(node);
        const nav = document.createElement("div");
        nav.id = "prev-next";
        const prev = siblings[idx - 1];
        const next = siblings[idx + 1];
        if (prev) {
          const aPrev = document.createElement("a");
          aPrev.textContent = "← " + (prev.title || prev.name);
          aPrev.href = `#${hashForNode(prev)}`;
          nav.appendChild(aPrev);
        } else nav.appendChild(document.createElement("span"));
        if (next) {
          const aNext = document.createElement("a");
          aNext.textContent = (next.title || next.name) + " →";
          aNext.href = `#${hashForNode(next)}`;
          nav.appendChild(aNext);
        }
        document.getElementById("content-wrapper").appendChild(nav);
      }

      function hashForNode(node) {
        const chain = [];
        let n = node;
        while (n && n.parent) {
          chain.unshift(n.id || n.name);
          n = n.parent;
        }
        return chain.join("#");
      }

      /* ─── D3 Graph ──────────────────────────────────────────────────── */
      function buildGraphData(root) {
        const nodes = [];
        const links = [];
        let idx = 0;
        function dfs(n) {
          n._index = idx++;
          nodes.push({ id: n._index, label: n.title || n.name, ref: n });
          if (n.children) {
            n.children.forEach((c) => {
              links.push({ source: n._index, target: idx });
              dfs(c);
            });
          }
        }
        dfs(root);
        return { nodes, links };
      }

      function renderGraph() {
        const { nodes, links } = buildGraphData(fileTree);
        const svgMini = d3.select("#mini-graph");
        const svgFull = d3.select("#full-graph");
        [svgMini, svgFull].forEach((svg) => {
          svg.selectAll("*").remove();
          const width = parseInt(svg.style("width"));
          const height = parseInt(svg.style("height"));
          const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id((d) => d.id).distance(80))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2));

          const link = svg.append("g")
            .attr("stroke", "#555")
            .attr("stroke-width", 1)
            .selectAll("line")
            .data(links)
            .join("line");

          const node = svg.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 0.5)
            .selectAll("circle")
            .data(nodes)
            .join("circle")
            .attr("r", 6)
            .attr("fill", (d) => d.ref.type === "folder" ? "#8a8a8a" : "#569cd6")
            .on("click", (event, d) => navigateTo(d.ref));

          const label = svg.append("g")
            .selectAll("text")
            .data(nodes)
            .join("text")
            .attr("font-size", 10)
            .attr("fill", "#aaa")
            .text((d) => d.label);

          simulation.on("tick", () => {
            link
              .attr("x1", (d) => d.source.x)
              .attr("y1", (d) => d.source.y)
              .attr("x2", (d) => d.target.x)
              .attr("y2", (d) => d.target.y);
            node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
            label
              .attr("x", (d) => d.x + 8)
              .attr("y", (d) => d.y + 3);
          });
        });
      }

      /* ─── Navigation — main entry point ─────────────────────────────── */
      function navigateTo(node) {
        location.hash = hashForNode(node);
      }

      async function router() {
        if (!fileTree) {
          fileTree = await buildFileTree();
          renderSidebar(fileTree, document.getElementById("sidebar"));
          renderGraph();
        }
        const { pathArray } = hashToPath();
        const node = findNodeByHash(pathArray);
        currentNode = node;
        renderBreadcrumb(node || fileTree);
        if (node && node.type === "file") await renderContent(node);
        else if (node && node.type === "folder") {
          // default to home.md inside folder
          const homeChild = node.children.find((c) => c.name === "home" && c.type === "file");
          if (homeChild) navigateTo(homeChild);
        }
      }

      /* ─── Graph modal control ──────────────────────────────────────── */
      document.getElementById("expand-graph").onclick = () => {
        document.getElementById("graph-modal").classList.add("open");
      };
      document.querySelector("#graph-modal .close").onclick = () => {
        document.getElementById("graph-modal").classList.remove("open");
      };

      /* ─── Init ─────────────────────────────────────────────────────── */
      window.addEventListener("hashchange", router);
      router();
    </script>
  </body>
</html>
