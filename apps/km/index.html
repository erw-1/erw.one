<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>km ‚Äì Static Wiki</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>

<style>
/* m√™me feuille que pr√©c√©demment + input search ajout√© */
:root{--bg:#1e1e1e;--bg-alt:#2a2a2a;--fg:#d4d4d4;--accent:#569cd6;--shadow:0 2px 6px rgba(0,0,0,.4);}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--fg);
     display:flex;min-height:100vh;overflow:hidden}
/* SIDEBAR */
#sidebar{width:260px;background:var(--bg-alt);padding:.5rem;overflow-y:auto;border-right:1px solid #444}
#search{width:100%;padding:.4rem .6rem;margin-bottom:.5rem;border:none;border-radius:6px;
        background:#3a3a3a;color:var(--fg)}
#sidebar ul{list-style:none;padding-left:.6em;margin:0}
#sidebar li{margin:.15em 0;cursor:pointer}
#sidebar li:hover{color:var(--accent)}
.folder>span::before{content:"‚ñ∏";display:inline-block;margin-right:4px;transition:.2s}
.folder>ul{display:none}
.folder.open>span::before{transform:rotate(90deg)}
.folder.open>ul{display:block}
/* LAYOUT */
main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#content-area{flex:1;display:flex;overflow:hidden}
/* HEADER / BREADCRUMB */
header{background:var(--bg-alt);padding:0 1rem;height:48px;display:flex;align-items:center;gap:.5rem;
       box-shadow:var(--shadow);user-select:none}
header a,header span{color:var(--fg);text-decoration:none;display:flex;align-items:center;
                     padding:4px 8px;border-radius:6px}
header a:hover{background:#3a3a3a}.crumb-current{background:#3a3a3a;cursor:default}
.separator{margin:0 .25rem}.dropdown{position:relative}
.dropdown ul{display:none;position:absolute;top:100%;left:0;min-width:160px;background:#3a3a3a;
            border-radius:4px;padding:.25rem 0;list-style:none;z-index:20}
.dropdown ul li{padding:6px 12px;white-space:nowrap}.dropdown ul li:hover{background:var(--accent)}
.dropdown:hover>ul,.dropdown:focus-within>ul{display:block}
/* UTILITY (graph+toc) */
#utility-bar{display:flex;flex-direction:column;width:300px;flex-shrink:0;padding:.75rem .5rem;
             background:var(--bg);border-left:1px solid #444;gap:1rem}
#graph-container{height:240px;position:relative;border:1px solid #333;border-radius:8px}
#graph-container svg{width:100%;height:100%}
#toc{flex:1;overflow:auto;border:1px solid #333;border-radius:8px;padding:.5rem}
#toc ul{list-style:none;padding-left:.6em;margin:0}#toc a{color:var(--accent);text-decoration:none}
/* ARTICLE */
#content-wrapper{flex:1;overflow-y:auto;padding:1rem 2rem;max-width:960px;margin:0 auto}
#content-wrapper h1,#content-wrapper h2,#content-wrapper h3,
#content-wrapper h4,#content-wrapper h5{scroll-margin-top:70px}
#prev-next{display:flex;justify-content:space-between;margin:2rem 0}
#prev-next a{background:#3a3a3a;padding:.6rem 1rem;border-radius:6px;color:var(--fg);text-decoration:none}
#prev-next a:hover{background:var(--accent)}
/* GRAPH MODAL */
#graph-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;
             justify-content:center;visibility:hidden;opacity:0;transition:.2s;z-index:30}
#graph-modal.open{visibility:visible;opacity:1}
#graph-modal .close{position:absolute;top:1rem;right:1rem;font-size:2rem;cursor:pointer;color:#fff}
#graph-modal svg{width:80vw;height:80vh}
/* SCROLLBAR */
::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:var(--bg-alt)}
::-webkit-scrollbar-thumb{background:#555;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#666}
</style>
</head>

<body>
  <aside id="sidebar">
    <input id="search" type="search" placeholder="Recherche‚Ä¶">
  </aside>

  <main>
    <header id="breadcrumb"></header>

    <div id="content-area">
      <article id="content-wrapper"></article>

      <section id="utility-bar">
        <div id="graph-container">
          <svg id="mini-graph"></svg>
          <button id="expand-graph" style="position:absolute;top:8px;right:8px">üîç</button>
        </div>
        <nav id="toc"></nav>
      </section>
    </div>
  </main>

  <div id="graph-modal">
    <span class="close">‚úï</span>
    <svg id="full-graph"></svg>
  </div>

<script>
/* ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const CONFIG={
  user:"erw-1",
  repo:"erw.one",
  branch:"main",
  contentFile:"apps/km/content.md"         // unique fichier MD
};

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let pages=[], pageById={}, root=null;

/* ‚îÄ‚îÄ‚îÄ FETCH & PARSE content.md ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadPages(){
  const rawURL=`https://raw.githubusercontent.com/${CONFIG.user}/${CONFIG.repo}/${CONFIG.branch}/${CONFIG.contentFile}`;
  const text=await fetch(rawURL).then(r=>r.text());

  const regex=/<!--([\s\S]*?)-->\s*([\s\S]*?)(?=<!--|$)/g;
  let m;
  while((m=regex.exec(text))){
    const metaBlock=m[1], body=m[2];
    const meta={};
    metaBlock.replace(/(\w+):"([^"]+)"/g,(_,k,v)=>meta[k.trim()]=v.trim());
    const page={...meta,content:body.trim(),children:[],parent:null};
    pageById[page.id]=page;
    pages.push(page);
  }

  // establish hierarchy & root
  pages.forEach(p=>{
    if(p.parent){
      const par=pageById[p.parent];
      if(par){ p.parent=par; par.children.push(p); }
    }
  });
  root=pages.find(p=>p.type==="home")||pages[0];

  // build tag index for graph links by tags
  pages.forEach(p=>p.tagSet=new Set((p.tags||"").split(",").map(t=>t.trim()).filter(Boolean)));
}

/* ‚îÄ‚îÄ‚îÄ ROUTING helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const hashParts     = ()=>decodeURIComponent(location.hash.slice(1)).split("#").filter(Boolean);
const hashForPage   = p => { const arr=[]; for(let n=p;n&&n.parent;n=n.parent) arr.unshift(n.id); return arr.join("#"); };
const findPage      = parts => parts.reduce((n,id)=>n&&n.children.find(c=>c.id===id),(parts[0]?root:null))||root;

/* ‚îÄ‚îÄ‚îÄ SIDEBAR & SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildSidebar(){
  const box=document.getElementById("sidebar");
  const ul=document.createElement("ul"); box.appendChild(ul);
  const rec=(p,container)=>{
    const li=document.createElement("li"); container.appendChild(li);
    if(p.children.length){
      li.className="folder";
      const span=document.createElement("span"); span.textContent=p.title; li.appendChild(span);
      const sub=document.createElement("ul"); li.appendChild(sub);
      span.onclick=()=>li.classList.toggle("open");
      p.children.forEach(ch=>rec(ch,sub));
    }else{
      li.textContent=p.title;
      li.onclick=()=>navigateTo(p);
    }
    li.dataset.title=p.title.toLowerCase();
  };
  root.children.forEach(ch=>rec(ch,ul));

  /* simple search filter */
  const search=document.getElementById("search");
  search.oninput=()=>{
    const q=search.value.toLowerCase();
    box.querySelectorAll("li").forEach(li=>{
      li.style.display=li.dataset.title.includes(q)?"":"none";
    });
  };
}

/* ‚îÄ‚îÄ‚îÄ BREADCRUMB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function breadcrumb(page){
  const h=document.getElementById("breadcrumb"); h.innerHTML="";
  const home=document.createElement("a"); home.innerHTML="üè†"; home.href="#"; h.appendChild(home);
  const chain=[]; for(let n=page;n;n=n.parent) chain.unshift(n);
  chain.shift();                                                  // skip home
  chain.forEach((p,i)=>{
    const sep=document.createElement("span"); sep.className="separator"; sep.textContent=">"; h.appendChild(sep);

    const hasSib=p.parent && p.parent.children.length>1;
    const wrap=document.createElement(hasSib?"div":"a"); if(hasSib) wrap.className="dropdown";

    const link=document.createElement("a"); link.textContent=p.title;
    link.className=i===chain.length-1?"crumb-current":""; link.href="#"+hashForPage(p);

    if(!hasSib){ h.appendChild(link); return; }
    wrap.appendChild(link);
    const ul=document.createElement("ul");
    p.parent.children.forEach(s=>{
      const li=document.createElement("li"); li.textContent=s.title;
      li.onclick=()=>navigateTo(s); ul.appendChild(li);
    });
    wrap.appendChild(ul); h.appendChild(wrap);
  });
}

/* ‚îÄ‚îÄ‚îÄ TOC & Prev/Next ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderTOC(){
  const nav=document.getElementById("toc"); nav.innerHTML="";
  const heads=document.querySelectorAll("#content-wrapper h1, #content-wrapper h2, #content-wrapper h3");
  if(!heads.length) return;
  const ul=document.createElement("ul");
  heads.forEach(h=>{
    const li=document.createElement("li");
    const a=document.createElement("a"); a.href="#"+h.id; a.textContent=h.textContent;
    li.appendChild(a); ul.appendChild(li);
  });
  nav.appendChild(ul);
}
function renderPrevNext(page){
  document.getElementById("prev-next")?.remove();
  if(!page.parent) return;
  const sib=page.parent.children;
  if(sib.length<2) return;
  const idx=sib.indexOf(page);
  const nav=document.createElement("div"); nav.id="prev-next";
  if(sib[idx-1]){
    const a=document.createElement("a"); a.href="#"+hashForPage(sib[idx-1]);
    a.textContent="‚Üê "+sib[idx-1].title; nav.appendChild(a);
  }else nav.appendChild(document.createElement("span"));
  if(sib[idx+1]){
    const a=document.createElement("a"); a.href="#"+hashForPage(sib[idx+1]);
    a.textContent=sib[idx+1].title+" ‚Üí"; nav.appendChild(a);
  }
  document.getElementById("content-wrapper").appendChild(nav);
}

/* ‚îÄ‚îÄ‚îÄ MARKDOWN RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderContent(page){
  const art=document.getElementById("content-wrapper");
  art.innerHTML=marked.parse(page.content,{headerIds:true});
  document.title=page.title+" ‚Äì km";
  hljs.highlightAll();
  renderTOC(); renderPrevNext(page);
}

/* ‚îÄ‚îÄ‚îÄ GRAPH (hierarchy + tags) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildGraphData(){
  const nodes=[],links=[];
  pages.forEach((p,i)=>p._i=i);
  pages.forEach(p=>{
    nodes.push({id:p._i,label:p.title,ref:p});
    if(p.parent) links.push({source:p._i,target:p.parent._i,kind:"hier"});
  });
  const tagMap=new Map();
  pages.forEach(p=>{
    p.tagSet.forEach(t=>{
      if(!tagMap.has(t)) tagMap.set(t,[]);
      tagMap.get(t).push(p);
    });
  });
  tagMap.forEach(list=>{
    for(let i=0;i<list.length;i++)
      for(let j=i+1;j<list.length;j++){
        const a=list[i],b=list[j];
        // test if link already hier => mark both
        const existing=links.find(l=>l.source===a._i&&l.target===b._i||l.source===b._i&&l.target===a._i);
        if(existing){ existing.kind="both"; }
        else links.push({source:a._i,target:b._i,kind:"tag"});
      }
  });
  return {nodes,links};
}
function drag(sim){return d3.drag().on("start",(e,d)=>{if(!e.active)sim.alphaTarget(.3).restart();d.fx=d.x;d.fy=d.y;})
                           .on("drag",(e,d)=>{d.fx=e.x;d.fy=e.y;})
                           .on("end",(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=d.fy=null;});}
function renderGraph(){
  const {nodes,links}=buildGraphData();
  ["mini-graph","full-graph"].forEach(id=>{
    const svg=d3.select("#"+id); svg.selectAll("*").remove();
    const w=svg.node().clientWidth||300,h=svg.node().clientHeight||200;
    const sim=d3.forceSimulation(nodes)
      .force("link",d3.forceLink(links).id(d=>d.id).distance(80))
      .force("charge",d3.forceManyBody().strength(-250))
      .force("center",d3.forceCenter(w/2,h/2));
    const colorByKind=k=>k==="hier"?"#569cd6":k==="tag"?"#2ecc71":"#00c8c8";
    const link=svg.append("g").attr("stroke-width",1)
      .selectAll("line").data(links).join("line")
      .attr("stroke",d=>colorByKind(d.kind));
    const node=svg.append("g").attr("stroke","#fff").attr("stroke-width",.5)
      .selectAll("circle").data(nodes).join("circle")
      .attr("r",6).attr("fill",d=>d.ref.type==="folder"?"#8a8a8a":"#569cd6")
      .call(drag(sim)).on("click",(e,d)=>navigateTo(d.ref));
    const label=svg.append("g").selectAll("text").data(nodes).join("text")
      .attr("font-size",10).attr("fill","#aaa").text(d=>d.label);
    sim.on("tick",()=>{
      link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y)
          .attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
      node.attr("cx",d=>d.x).attr("cy",d=>d.y);
      label.attr("x",d=>d.x+8).attr("y",d=>d.y+3);
    });
  });
}

/* ‚îÄ‚îÄ‚îÄ NAVIGATION & ROUTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function navigateTo(p){ location.hash="#"+hashForPage(p); }
function router(){
  const p=findPage(hashParts());
  breadcrumb(p); renderContent(p);
}

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(async()=>{
  await loadPages();
  buildSidebar();
  renderGraph();
  window.addEventListener("hashchange",router,false);
  router();
})();
document.getElementById("expand-graph")
        .onclick=()=>document.getElementById("graph-modal").classList.add("open");
document.querySelector("#graph-modal .close")
        .onclick=()=>document.getElementById("graph-modal").classList.remove("open");
</script>
</body>
</html>
