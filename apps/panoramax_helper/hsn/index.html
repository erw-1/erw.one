<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi GPS – Leaflet</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html, body {height: 100%; margin: 0;}
        #map {height: 100%; width: 100%;}
        /* Bouton en bas‑à‑droite */
        #trackButton {
            position: absolute; bottom: 1rem; right: 1rem; z-index: 1000;
            background:#fff; border:2px solid #666; border-radius:4px;
            padding:0.5rem 1rem; font-size:1rem; cursor:pointer;
            box-shadow:0 2px 6px rgba(0,0,0,.3);
        }
    </style>
</head>
<body>
    <button id="trackButton">commencer</button>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Plugin VectorTileLayer (UMD) -->
    <script src="https://unpkg.com/leaflet-vector-tile-layer@0.16.1/dist/VectorTileLayer.umd.min.js"></script>
    <!-- Leaflet‑rotate pour la boussole / rotation -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

    <script>
        // ------------------------------------------------------------------
        // Carte de base
        // ------------------------------------------------------------------
        const map = L.map('map', { preferCanvas:true }).setView([46.5, 2.5], 12);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom:19,
            attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &bull; Tiles &copy; CartoDB'
        }).addTo(map);

        // ------------------------------------------------------------------
        // Couche Panoramax – uniquement LineString, on « over‑zoome » après Z15
        // ------------------------------------------------------------------
        const panoramaxURL = 'https://api.panoramax.xyz/api/users/e4933c0c-653b-429a-833a-f45f64e41726/map/{z}/{x}/{y}.mvt';

        const vtOptions = {
            filter: (f) => f && f.type === 2,   // 2 = LineString
            style:  { color:'red', weight:3, opacity:1 },
            maxDetailZoom: 15                // utilise les tuiles du Z15 au‑delà
        };

        let redLayer;
        if (typeof window.VectorTileLayer === 'function') {
            redLayer = new VectorTileLayer(panoramaxURL, vtOptions).addTo(map);
        } else if (typeof window.vectorTileLayer === 'function') {
            redLayer = window.vectorTileLayer(panoramaxURL, vtOptions).addTo(map);
        } else if (L && L.vectorTileLayer) {
            redLayer = L.vectorTileLayer(panoramaxURL, vtOptions).addTo(map);
        } else {
            console.error('VectorTileLayer non trouvé : le plugin ne s\'est pas chargé');
        }

        // Zoom initial sur l'emprise de la couche une fois chargée
        if (redLayer) {
            redLayer.once('load', () => {
                if (redLayer.getBounds && redLayer.getBounds().isValid()) {
                    map.fitBounds(redLayer.getBounds());
                }
            });
        }

        // ------------------------------------------------------------------
        // Suivi GPS – bleu puis vert & export GeoJSON
        // ------------------------------------------------------------------
        let isTracking = false;
        let watchId = null;
        let currentCoords = [];
        let currentLine = null;
        const lineWeight = 3; // identique à la couche rouge

        const trackButton = document.getElementById('trackButton');
        trackButton.addEventListener('click', () => isTracking ? stopTracking() : startTracking());

        function startTracking() {
            if (!navigator.geolocation) { alert('La géolocalisation n\'est pas supportée.'); return; }
            isTracking = true; trackButton.textContent = 'terminer';
            currentCoords = []; currentLine = L.polyline([], {color:'blue', weight:lineWeight}).addTo(map);

            // Active la rotation si le plugin est chargé
            if (map.rotation && map.rotation.enable) {
                map.rotation.enable();
            }
            if (L.Control && L.Control.Rotate) {
                L.control.rotate({ position:'topright' }).addTo(map);
            }

            watchId = navigator.geolocation.watchPosition(onPos, onGeoError, { enableHighAccuracy:true, maximumAge:5000, timeout:20000 });
        }

        function onPos(pos) {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            currentCoords.push(latlng);
            currentLine.setLatLngs(currentCoords);
            map.panTo(latlng, { animate:false }); // centre sans changer de niveau de zoom
        }

        function onGeoError(err) { console.error(err); alert('Erreur géoloc : '+err.message); }

        function stopTracking() {
            if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            isTracking = false; trackButton.textContent = 'commencer';
            if (currentLine) { currentLine.setStyle({color:'green'}); }
            if (currentCoords.length > 1) { exportGeoJSON(currentCoords); }
            currentCoords = []; currentLine = null;

            // Désactive la rotation pour revenir à un comportement normal
            if (map.rotation && map.rotation.disable) {
                map.rotation.disable();
            }
        }

        function exportGeoJSON(coords) {
            const feature = {
                type:'Feature',
                properties:{ finishedAt:new Date().toISOString() },
                geometry:{ type:'LineString', coordinates:coords.map(([lat,lon])=>[lon,lat]) }
            };
            const blob = new Blob([JSON.stringify({type:'FeatureCollection',features:[feature]})], {type:'application/geo+json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'trace_'+new Date().toISOString().replace(/[:.]/g,'-')+'.geojson';
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
