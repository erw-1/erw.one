<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Suivi GPS – Leaflet</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html, body {height: 100%; margin: 0;}
        #map {height: 100%; width: 100%;}

        /* Bouton principal – mobile friendly */
        #trackButton {
            position: absolute;
            bottom: 1.2rem;
            right: 1.2rem;
            z-index: 1000;
            background:#fff;
            border:2px solid #666;
            border-radius:8px;
            padding:1rem 1.6rem;          /* plus grand */
            font-size:1.1rem;
            cursor:pointer;
            box-shadow:0 4px 10px rgba(0,0,0,.3);
            touch-action:manipulation;     /* évite le délai 300 ms sur iOS */
        }

        /* Rotation control + flèche – agrandis pour le doigt */
        .leaflet-control-rotate {
            width:48px; height:48px;       /* carré plus large */
        }
        .leaflet-control-rotate-arrow {
            border-width:10px 6px 0 6px;   /* flèche plus épaisse */
        }
    </style>
</head>
<body>
    <button id="trackButton">commencer</button>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Plugin VectorTileLayer (UMD) -->
    <script src="https://unpkg.com/leaflet-vector-tile-layer@0.16.1/dist/VectorTileLayer.umd.min.js"></script>
    <!-- Leaflet‑rotate pour la boussole / rotation -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

    <script>
        // ------------------------------------------------------------------
        // Carte de base (sans contrôles +/‑)
        // ------------------------------------------------------------------
        const map = L.map('map', {
            zoomControl:false,     // supprime les boutons zoom
            rotate:true,
            touchRotate:true,
            rotateControl:{ closeOnZeroBearing:false },
            preferCanvas:true
        }).setView([46.5, 2.5], 6); // France entière

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom:19,
            attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &bull; Tiles &copy; CartoDB'
        }).addTo(map);

        // ------------------------------------------------------------------
        // Couche Panoramax – uniquement LineString, over‑zoom après Z15
        // ------------------------------------------------------------------
        const panoramaxURL = 'https://api.panoramax.xyz/api/users/e4933c0c-653b-429a-833a-f45f64e41726/map/{z}/{x}/{y}.mvt';

        const vtOptions = {
            filter: (f) => f && f.type === 2,
            style:  { color:'red', weight:3, opacity:1 },
            maxDetailZoom: 15
        };

        const redLayer = (window.VectorTileLayer ? new VectorTileLayer(panoramaxURL, vtOptions)
                         : (window.vectorTileLayer ? window.vectorTileLayer(panoramaxURL, vtOptions)
                         : (L.vectorTileLayer ? L.vectorTileLayer(panoramaxURL, vtOptions)
                         : null)));
        if (redLayer) redLayer.addTo(map);

        // Zoom initial sur l'emprise de la couche une fois chargée
        if (redLayer) {
            redLayer.once('load', () => {
                const bounds = (typeof redLayer.getBounds === 'function') ? redLayer.getBounds() : null;
                if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds);
            });
        }

        // ------------------------------------------------------------------
        // Fonction pour cliquer sur la flèche de rotation (unique)
        // ------------------------------------------------------------------
        function clickRotateArrow() {
            const arrow = document.querySelector('span.leaflet-control-rotate-arrow');
            if (arrow) arrow.dispatchEvent(new PointerEvent('pointerdown'));
        }

        // ------------------------------------------------------------------
        // Suivi GPS – bleu puis vert & export GeoJSON
        // ------------------------------------------------------------------
        let isTracking = false;
        let watchId = null;
        let currentCoords = [];
        let currentLine = null;
        const lineWeight = 3;

        const trackButton = document.getElementById('trackButton');
        trackButton.addEventListener('click', () => isTracking ? stopTracking() : startTracking());

        function startTracking() {
            if (!navigator.geolocation) { alert('La géolocalisation n\'est pas supportée.'); return; }
            isTracking = true; trackButton.textContent = 'terminer';
            currentCoords = [];
            currentLine = L.polyline([], {color:'blue', weight:lineWeight}).addTo(map);
            watchId = navigator.geolocation.watchPosition(onPos, onGeoError, { enableHighAccuracy:true, maximumAge:5000, timeout:20000 });
            clickRotateArrow();
        }

        function onPos(pos) {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            currentCoords.push(latlng);
            currentLine.setLatLngs(currentCoords);
            map.panTo(latlng, { animate:false });
        }

        function onGeoError(err) { console.error(err); alert('Erreur géoloc : '+err.message); }

        function stopTracking() {
            if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            isTracking = false; trackButton.textContent = 'commencer';
            if (currentLine) currentLine.setStyle({color:'green'});
            if (currentCoords.length > 1) exportGeoJSON(currentCoords);
            currentCoords = []; currentLine = null;
            clickRotateArrow();
            clickRotateArrow();
        }

        function exportGeoJSON(coords) {
            const feature = {
                type:'Feature',
                properties:{ finishedAt:new Date().toISOString() },
                geometry:{ type:'LineString', coordinates:coords.map(([lat,lon])=>[lon,lat]) }
            };
            const blob = new Blob([JSON.stringify({type:'FeatureCollection',features:[feature]})], {type:'application/geo+json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'trace_'+new Date().toISOString().replace(/[:.]/g,'-')+'.geojson';
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
