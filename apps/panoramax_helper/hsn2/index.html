<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi GPS – Leaflet</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" />

    <style>
        html,body{height:100%;margin:0}
        #map{height:100%;width:100%}
        *{font-family:'Poppins',sans-serif}

        #search-container{width:320px;position:fixed;top:1rem;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,.5);backdrop-filter:blur(5px);border-radius:4px}
        #addressInput{width:313px;font-size:1.2rem;border-radius:4px}
        #addressSuggestions{list-style:none;margin:2px 0 0;padding:0}
        #addressSuggestions li{border-radius:4px;margin-bottom:1px;background:rgba(255,255,255,.5);border:1px solid rgba(0,0,0,.5);cursor:pointer}
        #trackButton{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);z-index:1000;background:#fff;border:2px solid #666;border-radius:4px;padding:.5rem 1rem;font-size:4rem;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3)}
        .leaflet-control-attribution.leaflet-control{display:none}
        #spinner{position:fixed;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,transparent,rgba(0,0,0,.4) 50%,transparent);background-size:200% 100%;animation:spin 1.2s linear infinite;z-index:2000;display:none}
        @keyframes spin{to{background-position:-200% 0}}
    </style>
</head>
<body>
    <!-- loader itinéraire -->
    <div id="spinner"></div>
    <!-- Recherche d'adresse -->
    <div id="search-container">
        <input id="addressInput" type="text" placeholder="Rechercher une adresse…" />
        <ul id="addressSuggestions"></ul>
    </div>
    <!-- Bouton de suivi -->
    <button id="trackButton">Commencer</button>
    <!-- Carte -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-vector-tile-layer@0.16.1/dist/VectorTileLayer.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

    <script>
    (()=>{
        "use strict";

        // ------------------------------------------------------------------
        // Constantes & configuration
        // ------------------------------------------------------------------
        const ORS_API_KEY = "5b3ce3597851110001cf624873a9f82e7dce4b46a1e049860a2c461d";
        const LINE_WEIGHT = 3;
        const FETCH_TIMEOUT = 10000; // ms

        // ------------------------------------------------------------------
        // Helpers DOM / divers
        // ------------------------------------------------------------------
        const $ = sel=>document.querySelector(sel);
        const clickCompass = ()=>$('span.leaflet-control-rotate-arrow')?.click();
        const debounce = (fn,delay=250)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),delay)}};
        const withTimeout = (promise,ms=FETCH_TIMEOUT)=>Promise.race([
            promise,
            new Promise((_,rej)=>setTimeout(()=>rej(new Error('Délai dépassé')),ms))
        ]);
        const spinner={show:()=>$('#spinner').style.display='block',hide:()=>$('#spinner').style.display='none'};

        // ------------------------------------------------------------------
        // Carte de base
        // ------------------------------------------------------------------
        const map = L.map('map',{zoomControl:false,rotate:true,touchRotate:true,rotateControl:{closeOnZeroBearing:false},preferCanvas:true}).setView([46.5,2.5],6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &bull; Tiles &copy; CartoDB'}).addTo(map);

        // couche panoramax
        const panoramaxURL='https://api.panoramax.xyz/api/users/e4933c0c-653b-429a-833a-f45f64e41726/map/{z}/{x}/{y}.mvt';
        (window.VectorTileLayer||window.vectorTileLayer||L.vectorTileLayer)?.(panoramaxURL,{filter:f=>f?.type===2,style:{color:'red',weight:3,opacity:1},maxDetailZoom:15}).addTo(map)?.once('load',e=>{const b=e.target.getBounds?.();b?.isValid?.()&&map.fitBounds(b)});

        // ------------------------------------------------------------------
        // État tracking
        // ------------------------------------------------------------------
        let isTracking=false,watchId=null,currentCoords=[],currentLine=null,addrRouteLayer=null;

        const trackButton=$('#trackButton');
        trackButton.onclick=()=>isTracking?stopTracking():startTracking();

        // arrête le tracking quand l'onglet est masqué
        document.addEventListener('visibilitychange',()=>document.hidden&&isTracking&&stopTracking());

        function startTracking(){
            if(!navigator.geolocation)return alert('La géolocalisation n\'est pas supportée.');
            isTracking=true;
            trackButton.textContent='Terminer';
            currentCoords=[];
            currentLine=L.polyline([],{color:'blue',weight:LINE_WEIGHT}).addTo(map);
            watchId=navigator.geolocation.watchPosition(onPos,onGeoError,{enableHighAccuracy:true,maximumAge:5000,timeout:20000});
            clickCompass();
            navigator.vibrate?.([15]);
        }
        function stopTracking(){
            watchId!==null&&navigator.geolocation.clearWatch(watchId);
            isTracking=false;
            trackButton.textContent='Commencer';
            currentLine?.setStyle({color:'green'});
            currentCoords.length>1&&exportGeoJSON(currentCoords);
            currentCoords=[];currentLine=null;
            clickCompass();clickCompass();
            navigator.vibrate?.([15]);
        }
        const onPos=({coords:{latitude,longitude}})=>{const ll=[latitude,longitude];currentCoords.push(ll);currentLine?.setLatLngs(currentCoords);map.panTo(ll,{animate:false})};
        const onGeoError=e=>{console.error(e);alert('Erreur géoloc : '+e.message)};

        const exportGeoJSON=coords=>{
            const blob=new Blob([JSON.stringify({type:'FeatureCollection',features:[{type:'Feature',properties:{finishedAt:new Date().toISOString()},geometry:{type:'LineString',coordinates:coords.map(([lat,lon])=>[lon,lat])}}]})],{type:'application/geo+json'});
            const url=URL.createObjectURL(blob),a=document.createElement('a');
            a.href=url;a.download='trace_'+Date.now()+'.geojson';document.body.append(a);a.click();a.remove();URL.revokeObjectURL(url);
        };

        // ------------------------------------------------------------------
        // Géocodage auto‑complétion (avec AbortController + cache session)
        // ------------------------------------------------------------------
        const cache=JSON.parse(sessionStorage.getItem('geocodeCache')||'{}');
        let geoController=null;
        async function geocodeORS(query){
            if(cache[query])return cache[query];
            geoController?.abort();
            geoController=new AbortController();
            const url=`https://api.openrouteservice.org/geocode/autocomplete?api_key=${ORS_API_KEY}&text=${encodeURIComponent(query)}`;
            const r=await withTimeout(fetch(url,{signal:geoController.signal}));
            if(!r.ok)throw new Error('Erreur géocodage');
            const data=await r.json();
            const res=(data.features||[]).map(f=>({label:f.properties.label,coords:[f.geometry.coordinates[1],f.geometry.coordinates[0]]}));
            cache[query]=res;sessionStorage.setItem('geocodeCache',JSON.stringify(cache));
            return res;
        }

        const suggestionsUL=$('#addressSuggestions');
        function showSuggestions(list){
            const frag=document.createDocumentFragment();
            list.forEach(({label,coords})=>{const li=document.createElement('li');li.textContent=label;li.onclick=()=>{suggestionsUL.replaceChildren();$('#addressInput').value=label;routeToAddress(coords)};frag.append(li)});
            suggestionsUL.replaceChildren(frag);
        }

        $('#addressInput').addEventListener('input',debounce(async e=>{const val=e.target.value.trim();if(val.length<4)return showSuggestions([]);try{showSuggestions((await geocodeORS(val)).slice(0,3))}catch{showSuggestions([])}}));

        // ------------------------------------------------------------------
        // Polyline decode
        // ------------------------------------------------------------------
        const decodePolyline=str=>{let i=0,lat=0,lon=0,pts=[];while(i<str.length){let b,shift=0,res=0;do{b=str.charCodeAt(i++)-63;res|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);lat+=((res&1)?~(res>>1):(res>>1));shift=0;res=0;do{b=str.charCodeAt(i++)-63;res|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);lon+=((res&1)?~(res>>1):(res>>1));pts.push([lat/1e5,lon/1e5])}return pts};

        // ------------------------------------------------------------------
        // Itinéraire (avec spinner + timeout)
        // ------------------------------------------------------------------
        async function routeToAddress([lat2,lon2]){
            const requestRoute=async(lat1,lon1)=>{
                spinner.show();
                const body={coordinates:[[lon1,lat1],[lon2,lat2]],language:'fr',instructions:false};
                try{
                    const r=await withTimeout(fetch('https://api.openrouteservice.org/v2/directions/driving-car',{method:'POST',headers:{'Accept':'application/json, application/geo+json','Authorization':ORS_API_KEY,'Content-Type':'application/json'},body:JSON.stringify(body)}));
                    if(!r.ok)throw new Error('Route non disponible');
                    const data=await r.json();
                    const coords=decodePolyline(data.routes[0].geometry).map(([la,lo])=>[lo,la]);
                    addrRouteLayer?.remove();
                    addrRouteLayer=L.geoJSON({type:'Feature',geometry:{type:'LineString',coordinates:coords}}, {style:{color:'#333',weight:4,opacity:.8}}).addTo(map);
                    map.fitBounds(addrRouteLayer.getBounds(),{padding:[20,20]});
                }finally{spinner.hide();}
            };

            if(currentCoords.length){
                const [lat1,lon1]=currentCoords.at(-1);try{await requestRoute(lat1,lon1)}catch(e){alert(e.message)};return;
            }

            navigator.geolocation.getCurrentPosition(async({coords:{latitude:lat1,longitude:lon1}})=>{!isTracking&&startTracking();currentCoords.push([lat1,lon1]);currentLine?.setLatLngs(currentCoords);try{await requestRoute(lat1,lon1)}catch(e){alert(e.message)}} ,onGeoError,{enableHighAccuracy:true,timeout:20000});
            !isTracking&&startTracking();
        }
    })();
    </script>
</body>
</html>
